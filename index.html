<!DOCTYPE html>
<html lang="de" data-theme="neo">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self' data:; connect-src 'self'; media-src 'self' blob:; object-src 'none'; base-uri 'self'; frame-ancestors 'self'; form-action 'self'" />
<title>ModulTool – Singlefile Klick&Start</title>
<style>
  :root{--font:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",Arial,"Apple Color Emoji","Segoe UI Emoji";--radius:14px;--shadow:0 2px 8px rgba(0,0,0,.15);--gap:10px;--font-size:16px;--max-line:75ch}
  html{font-size:var(--font-size)}
  [data-theme="neo"]{--bg:#0f1115;--bg-soft:#151924;--panel:#1b2030;--panel-2:#232a3b;--text:#ecf2ff;--muted:#b8c1d8;--accent:#66d9ff;--info:#66d9ff;--ok:#00d680;--warn:#ffb000;--err:#ff4d4d;--input:#101522;--border:#2a3550;--link:#7be0ff;--badge:#2a3045}
  [data-theme="paper"]{--bg:#f8fafc;--bg-soft:#eef2f7;--panel:#fff;--panel-2:#f1f5fb;--text:#111827;--muted:#4b5563;--accent:#2563eb;--info:#2563eb;--ok:#059669;--warn:#d97706;--err:#dc2626;--input:#fff;--border:#d1d5db;--link:#1d4ed8;--badge:#e5e7eb}
  [data-theme="night"]{--bg:#000;--bg-soft:#0d0d0d;--panel:#111;--panel-2:#161616;--text:#fff;--muted:#d1d1d1;--accent:#00c2ff;--info:#00c2ff;--ok:#00ff99;--warn:#ffd000;--err:#ff4d4d;--input:#0a0a0a;--border:#2a2a2a;--link:#66d9ff;--badge:#1a1a1a}
  [data-theme="forest"]{--bg:#0e1a14;--bg-soft:#13241b;--panel:#162a21;--panel-2:#1d3429;--text:#e9fff5;--muted:#b7d8c9;--accent:#34d399;--info:#38bdf8;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444;--input:#0f1f19;--border:#2c4b3e;--link:#6ee7b7;--badge:#163428}
  [data-theme="aurora"]{--bg:#0b1020;--bg-soft:#101636;--panel:#121a3f;--panel-2:#192456;--text:#ecf2ff;--muted:#bfc8f2;--accent:#7cdbff;--info:#7cdbff;--ok:#6ee7b7;--warn:#ffd166;--err:#ff6b6b;--input:#0d1433;--border:#2a3a78;--link:#9ae6ff;--badge:#1a2160}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:var(--font);line-height:1.6;letter-spacing:.01em}
  body.font-large{line-height:1.7}
  a{color:var(--link)}
  .app{display:grid;grid-template-areas:"header header header" "left   main   right" "footer footer footer";grid-template-columns:280px 1fr 360px;grid-template-rows:auto 1fr auto;min-height:100vh}
  header{grid-area:header;background:var(--panel);box-shadow:var(--shadow);position:sticky;top:0;z-index:5}
  aside#left{grid-area:left;background:var(--panel-2);border-right:1px solid var(--border)}
  main{grid-area:main;background:var(--bg-soft)}
  aside#right{grid-area:right;background:var(--panel-2);border-left:1px solid var(--border)}
  footer{grid-area:footer;background:var(--panel);border-top:1px solid var(--border)}
  .row{display:flex;gap:var(--gap);align-items:center;flex-wrap:wrap}
  .col{display:flex;flex-direction:column;gap:var(--gap)}
  .pad{padding:12px 14px}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
  .panel p,.panel ul,.panel ol,.panel pre{max-width:var(--max-line)}
  .plugin-frame{width:100%;min-height:200px;border:0;border-radius:var(--radius);box-shadow:inset 0 0 0 1px var(--border);background:var(--panel-2);margin-top:12px}
  .plugin-frame:focus{outline:2px solid var(--accent);outline-offset:2px}
  .title{font-weight:700;letter-spacing:.3px}
  .muted{color:var(--muted)}
  .chip{display:inline-flex;align-items:center;gap:6px;background:var(--badge);border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-size:.85rem}
  .btn{cursor:pointer;user-select:none;border:1px solid var(--border);background:var(--panel-2);color:var(--text);border-radius:10px;padding:10px 12px;font-weight:600;box-shadow:var(--shadow)}
  .btn:hover{outline:2px solid var(--accent);outline-offset:1px}
  .btn.inline{padding:6px 10px;font-weight:600}
  .btn.warn{border-color:var(--warn)}
  .btn.ok{border-color:var(--ok)}
  .btn.err{border-color:var(--err)}
  .btn.block{width:100%;text-align:left}
  .btn:focus-visible,input:focus-visible,select:focus-visible,textarea:focus-visible,a:focus-visible,.dropzone:focus-visible{outline:3px solid var(--accent);outline-offset:3px}
  .btn:focus:not(:focus-visible),input:focus:not(:focus-visible),select:focus:not(:focus-visible),textarea:focus:not(:focus-visible),a:focus:not(:focus-visible),.dropzone:focus:not(:focus-visible){outline:none}
  .focus-ring{outline:3px solid var(--accent);outline-offset:3px}
  input[type=text],input[type=number],textarea,select{background:var(--input);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px;font-size:1rem}
  input::placeholder,textarea::placeholder{color:var(--muted)}
  label{font-size:.9rem;color:var(--muted)}
  hr{border:0;height:1px;background:var(--border)}
  .header-grid{display:grid;gap:var(--gap);grid-template-columns:1fr auto auto auto;align-items:stretch}
  .header-block{min-height:64px}
  .clock{font-size:1.25rem;font-variant-numeric:tabular-nums}
  .loglist{max-height:120px;overflow:auto}
  .log-entry{list-style:none;font-size:.9rem;border-bottom:1px dashed var(--border);padding:6px 0;display:grid;grid-template-columns:auto auto 1fr;gap:8px;align-items:start}
  .log-entry:last-child{border-bottom:0}
  .log-entry .log-icon{font-size:1rem;line-height:1}
  .log-entry .log-time{font-family:"Fira Mono",Consolas,monospace;color:var(--muted)}
  .log-entry[data-type="info"]{border-left:3px solid var(--info);padding-left:10px}
  .log-entry[data-type="ok"]{border-left:3px solid var(--ok);padding-left:10px}
  .log-entry[data-type="warn"]{border-left:3px solid var(--warn);padding-left:10px}
  .log-entry[data-type="error"]{border-left:3px solid var(--err);padding-left:10px}
  .log-entry[data-type="info"] .log-icon{color:var(--info)}
  .log-entry[data-type="ok"] .log-icon{color:var(--ok)}
  .log-entry[data-type="warn"] .log-icon{color:var(--warn)}
  .log-entry[data-type="error"] .log-icon{color:var(--err)}
  .log-entry .log-message{word-break:break-word}
  .log-empty{font-size:.9rem;color:var(--muted);padding:6px 0}
  .log-controls{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-bottom:6px}
  .status-banner{margin-top:8px;font-size:.85rem}
  .status-banner[data-type="info"]{color:var(--info)}
  .status-banner[data-type="ok"]{color:var(--ok)}
  .status-banner[data-type="warn"]{color:var(--warn)}
  .status-banner[data-type="error"]{color:var(--err)}
  .collapsed-left aside#left{display:none}
  .collapsed-left .app{grid-template-columns:0 1fr 360px}
  .collapsed-right aside#right{display:none}
  .collapsed-right .app{grid-template-columns:280px 1fr 0}
  .modules{display:flex;flex-direction:column;gap:8px}
  .modules .btn{display:flex;justify-content:space-between;align-items:center}
  .modules .small{font-size:.8rem;color:var(--muted)}
  .workspace{height:100%;padding:var(--gap)}
  .workspace .canvas{min-height:calc(70vh);background:var(--panel);border:1px dashed var(--border);border-radius:var(--radius);padding:16px}
  .playlist{max-height:38vh;overflow:auto;border:1px solid var(--border);border-radius:var(--radius);padding:8px;background:var(--panel)}
  .playlist .item{display:flex;justify-content:space-between;gap:10px;align-items:center;border-bottom:1px solid var(--border);padding:8px 6px;border-radius:10px;flex-wrap:wrap;outline:none}
  .playlist .item:last-child{border-bottom:none}
  .playlist .item:focus{outline:2px solid var(--accent);outline-offset:2px}
  .playlist .item[aria-selected="true"]{background:var(--panel-2)}
  .playlist .item .item-actions{display:flex;gap:6px;flex-wrap:wrap}
  .playlist .meta{display:flex;flex-direction:column}
  .dropzone{border:2px dashed var(--accent);border-radius:var(--radius);padding:16px;text-align:center}
  .footer-grid{display:grid;gap:var(--gap);grid-template-columns:repeat(4,1fr)}
  .listbox{max-height:140px;overflow:auto;background:var(--panel-2);border:1px solid var(--border);border-radius:var(--radius);padding:8px}
  .listbox li{list-style:none;border-bottom:1px dashed var(--border);padding:4px 0}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  .help-overlay{position:fixed;inset:0;background:rgba(15,17,21,.78);display:flex;align-items:center;justify-content:center;padding:24px;z-index:120;backdrop-filter:blur(2px)}
  .help-overlay[hidden]{display:none}
  body.help-open{overflow:hidden}
  .help-dialog{width:min(760px,100%);max-height:90vh;overflow:auto;background:var(--panel);border:2px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;display:flex;flex-direction:column;gap:16px}
  .help-header{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap}
  .help-header .title{margin:0}
  .help-intro{margin:0;font-size:.95rem;color:var(--muted)}
  .help-stats{font-size:.85rem;color:var(--muted)}
  .help-topic{border:1px solid var(--border);border-radius:12px;background:var(--panel-2);padding:14px;display:flex;flex-direction:column;gap:10px}
  .help-topic h3{margin:0;font-size:1.1rem}
  .help-steps{margin:0;padding-left:18px;display:flex;flex-direction:column;gap:6px}
  .help-steps li{line-height:1.5}
  .help-steps li p{margin:4px 0 0 0;color:var(--muted);font-size:.9rem}
  .help-shortcuts{display:flex;flex-wrap:wrap;gap:6px}
  .help-badge{display:inline-flex;align-items:center;gap:6px;background:var(--badge);border:1px solid var(--border);border-radius:999px;padding:4px 8px;font-size:.85rem}
  .help-badge strong{font-weight:700}
  .help-actions{display:flex;flex-direction:column;gap:6px}
  .help-action{display:flex;flex-direction:column;gap:4px}
  .help-action .muted{font-size:.85rem}
  .help-tips{margin:0;padding-left:18px;display:flex;flex-direction:column;gap:4px;font-size:.9rem;color:var(--muted)}
  .help-footer{display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap}
  .config-summary{margin-top:6px;font-size:.9rem;color:var(--muted);background:var(--panel-2);border:1px solid var(--border);border-radius:10px;padding:8px 10px}
  .config-overlay{position:fixed;inset:0;background:rgba(10,12,18,.8);display:flex;align-items:center;justify-content:center;padding:24px;z-index:130;backdrop-filter:blur(2px)}
  .config-overlay[hidden]{display:none}
  .config-dialog{width:min(820px,100%);max-height:90vh;overflow:auto;background:var(--panel);border:2px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px;display:flex;flex-direction:column;gap:18px}
  .config-header{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap}
  .config-header .title{margin:0}
  .config-intro{margin:0;font-size:.95rem;color:var(--muted)}
  .config-section{display:flex;flex-direction:column;gap:10px}
  .config-presets,.config-button-row{display:flex;flex-wrap:wrap;gap:8px}
  .config-presets .btn,.config-button-row .btn{flex:1 1 140px;justify-content:center;text-align:center}
  .config-presets .btn[aria-pressed="true"],.config-button-row .btn[aria-pressed="true"]{outline:3px solid var(--accent);outline-offset:2px}
  .config-list{margin:0;padding-left:20px;display:flex;flex-direction:column;gap:4px;font-size:.9rem;color:var(--muted)}
  .config-footer{display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap}
  .config-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .config-card{background:var(--panel-2);border:1px solid var(--border);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:8px}
  .config-card label{font-size:.95rem;color:var(--text)}
  .config-card p{margin:0;font-size:.85rem;color:var(--muted)}
  body.config-open{overflow:hidden}
  [data-motion="reduced"] *,[data-motion="reduced"] *::before,[data-motion="reduced"] *::after{animation-duration:.01ms !important;animation-iteration-count:1 !important;transition-duration:.01ms !important;scroll-behavior:auto !important}
  [data-contrast="high"] .panel,[data-contrast="high"] .btn{border-width:2px}
  [data-contrast="high"] .panel{box-shadow:0 0 0 2px var(--accent)}
  [data-contrast="high"] .btn{box-shadow:0 0 0 2px rgba(0,0,0,.2)}
  @media (max-width:1100px){.app{grid-template-columns:230px 1fr 0}aside#right{display:none}}
  @media (max-width:800px){.app{grid-template-columns:0 1fr 0}aside#left{display:none}.footer-grid{grid-template-columns:1fr}.header-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="app" id="app">
  <header class="pad" role="banner" aria-label="Dashboard Kopfbereich">
    <div class="header-grid">
      <div class="panel header-block pad" aria-live="polite">
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div>
            <div class="title" aria-label="Toolname">ModulTool – Dashboard</div>
            <div class="muted">Klick&Start • Offline • Robust</div>
            <div class="row" style="margin-top:6px;gap:6px;flex-wrap:wrap">
              <span class="chip" title="Anzahl Module"><strong id="stat-modules">0</strong> Module</span>
              <span class="chip" title="Anzahl Kategorien"><strong id="stat-cats">0</strong> Kategorien</span>
              <span class="chip" title="Genres im Archiv"><strong id="stat-genres">0</strong> Genres</span>
              <span class="chip" title="Moods im Archiv"><strong id="stat-moods">0</strong> Moods</span>
              <span class="chip" title="Playlist-Titel"><strong id="stat-tracks">0</strong> Tracks</span>
            </div>
          </div>
          <div class="col" style="min-width:220px;align-items:flex-end">
            <div class="clock" id="clock" aria-live="polite">--:--:--</div>
            <div class="muted" id="today">--.--.----</div>
            <div class="row" style="gap:6px">
              <label class="sr-only" for="themeSel">Theme wählen</label>
              <select id="themeSel" title="Farbschema wählen">
                <option value="neo">Neo</option>
                <option value="paper">Paper</option>
                <option value="night">Night HighContrast</option>
                <option value="forest">Forest</option>
                <option value="aurora">Aurora</option>
              </select>
              <button class="btn inline" id="toggleLeft" title="Linke Sidebar ein/aus">⟷ Links</button>
              <button class="btn inline" id="toggleRight" title="Rechte Sidebar ein/aus">⟷ Rechts</button>
            </div>
          </div>
        </div>
      </div>
      <div class="panel header-block pad" aria-label="Globale Einstellungen">
        <div class="title">Einstellungen</div>
        <div class="row">
          <label><input type="checkbox" id="autosaveChk"> Autospeichern</label>
          <label><input type="checkbox" id="selfrepairChk"> Self-Repair</label>
          <label><input type="checkbox" id="toastsChk" checked> Toast-Meldungen</label>
          <button class="btn inline" id="exportAllBtn" title="Alles als JSON exportieren">Export</button>
          <button class="btn inline" id="manifestBtn" title="Strukturelles Manifest herunterladen">Manifest</button>
          <button class="btn inline" id="configBtn" title="Konfigurations-Assistent öffnen">Assistent</button>
          <input type="file" id="importAllFile" title="JSON importieren" accept="application/json" />
        </div>
        <div class="row" style="margin-top:6px">
          <label><input type="checkbox" id="systemMotionChk"> System-Animationen nutzen</label>
          <label><input type="checkbox" id="reduceMotionChk"> Animationen reduzieren</label>
          <label><input type="checkbox" id="systemContrastChk"> System-Kontrast nutzen</label>
          <label><input type="checkbox" id="highContrastChk"> Hoher Kontrast</label>
          <label for="fontScaleSel">Schriftgröße</label>
          <select id="fontScaleSel" title="Schriftgröße wählen">
            <option value="14">14 px</option>
            <option value="16">16 px</option>
            <option value="18">18 px</option>
            <option value="20">20 px</option>
          </select>
        </div>
        <div class="muted">Alle Aktionen werden geloggt. Fehler werden erklärt und repariert, wenn möglich.</div>
        <div id="configSummary" class="config-summary" aria-live="polite">Paket: Allround (Standard) • Autospeichern aktiv • Animationen folgen der Systemeinstellung</div>
        <div id="processStatusLive" class="sr-only" aria-live="polite" aria-atomic="true">Prozessstatus bereit.</div>
        <div id="processStatusText" class="status-banner" data-type="info">Prozessstatus: bereit.</div>
      </div>
      <div class="panel header-block pad" aria-label="Echtzeit Logging">
        <div class="title">Log (letzte 10)</div>
        <div class="log-controls">
          <label for="logFilterSel">Anzeige</label>
          <select id="logFilterSel" title="Logfilter wählen">
            <option value="all">Alles</option>
            <option value="info">Nur Infos</option>
            <option value="ok">Nur Erfolge</option>
            <option value="warn">Nur Hinweise</option>
            <option value="error">Nur Fehler</option>
          </select>
        </div>
        <ul class="loglist" id="loglist" aria-live="polite"></ul>
        <div id="liveStatus" class="sr-only" aria-live="polite" aria-atomic="true">Status bereit.</div>
        <div id="liveStatusText" class="status-banner" data-type="info">Status: bereit.</div>
        <div class="row">
          <button class="btn inline warn" id="clearLogBtn">Log leeren</button>
          <button class="btn inline" id="downloadLogBtn">Log speichern</button>
        </div>
      </div>
      <div class="panel header-block pad" aria-label="Tastatur & Hilfe">
        <div class="title">Shortcuts & Hilfe</div>
        <div class="muted"><span>Strg+K: Suche</span> • <span>Strg+S: Speichern</span> • <span>F1: Hilfe</span></div>
        <div class="row" style="margin-top:8px">
          <input id="quickSearch" type="text" placeholder="Module durchsuchen… (Strg+K)" title="Suche in Modulen" />
          <button class="btn inline" id="aboutBtn">Info</button>
          <button class="btn inline" id="selfTestBtn" title="Selbsttest ausführen">Selbsttest</button>
        </div>
      </div>
    </div>
  </header>
  <aside id="left" class="pad" role="complementary" aria-label="Module">
    <div class="title" style="margin-bottom:8px">Module</div>
    <div class="row">
      <input id="newModuleName" type="text" placeholder="Neues Modul (Enter)" title="Modul hinzufügen"/>
      <button class="btn inline" id="addModuleBtn">Hinzufügen</button>
    </div>
    <hr />
    <div class="modules" id="modulesList" role="listbox" aria-label="Modulliste"></div>
  </aside>
  <main role="main" aria-label="Arbeitsfläche">
    <div class="workspace">
      <div class="canvas" id="canvas" tabindex="0" aria-label="Modulfläche">
        <h2>Willkommen im ModulTool</h2>
        <p>Wähle links ein Modul oder erstelle ein neues. Rechte Sidebar: Audioplayer & Playlist. Unten: Genres, Moods, Kategorien & Zufall.</p>
        <p class="muted">Alles ist offline, robust und speichert lokal (localStorage).</p>
      </div>
    </div>
  </main>
  <aside id="right" class="pad" role="complementary" aria-label="Audio & Playlist">
    <div class="title" style="margin-bottom:8px">Audio-Player</div>
    <div class="panel pad" style="display:flex;flex-direction:column;gap:10px">
      <audio id="player" preload="metadata" controls style="width:100%"></audio>
      <div class="row" style="justify-content:space-between">
        <div class="muted" id="nowMeta">–</div>
        <div class="row" style="gap:6px">
          <button class="btn inline" id="prevBtn" title="Vorheriger Track">⏮</button>
          <button class="btn inline" id="playBtn" title="Play/Pause">⏯</button>
          <button class="btn inline" id="nextBtn" title="Nächster Track">⏭</button>
        </div>
      </div>
      <div class="dropzone" id="dropzone" tabindex="0" title="Audio hierher ziehen oder klicken zum Auswählen">
        Dateien hier ablegen oder klicken zum Auswählen
        <input type="file" id="pickAudio" accept="audio/*" multiple style="display:none"/>
      </div>
      <div class="row" style="justify-content:space-between">
        <div>
          <button class="btn inline" id="impPlBtn" title="Playlist importieren (JSON)">Import</button>
          <button class="btn inline" id="expPlBtn" title="Playlist exportieren (JSON)">Export</button>
        </div>
        <div class="muted">Drag&Drop • Enter: Abspielen • Entf: Entfernen • Alt+Pfeile: Sortieren</div>
      </div>
    </div>
    <div class="panel pad" style="margin-top:10px">
      <div class="title">Playlist</div>
      <div class="playlist" id="playlist" role="listbox" aria-label="Playlist"></div>
    </div>
  </aside>
  <footer class="pad" role="contentinfo" aria-label="Fußbereich">
    <div class="footer-grid">
      <div class="panel pad">
        <div class="title">Genres (Archiv)</div>
        <label for="genreInput">Kommagetrennte Eingabe (Enter bestätigt)</label>
        <input id="genreInput" type="text" placeholder="z.B. techno, acid techno, hardgroove" title="Genres eingeben"/>
        <div class="row" style="justify-content:space-between">
          <button class="btn inline ok" id="addGenresBtn">Hinzufügen</button>
          <span class="muted">Anzahl: <strong id="countGenres">0</strong></span>
        </div>
        <ul class="listbox" id="genresList"></ul>
      </div>
      <div class="panel pad">
        <div class="title">Moods (Archiv)</div>
        <label for="moodInput">Kommagetrennte Eingabe (Enter bestätigt)</label>
        <input id="moodInput" type="text" placeholder="z.B. dark, uplifting, gritty" title="Moods eingeben"/>
        <div class="row" style="justify-content:space-between">
          <button class="btn inline ok" id="addMoodsBtn">Hinzufügen</button>
          <span class="muted">Anzahl: <strong id="countMoods">0</strong></span>
        </div>
        <ul class="listbox" id="moodsList"></ul>
      </div>
      <div class="panel pad">
        <div class="title">Kategorien</div>
        <div class="row">
          <input id="catName" type="text" placeholder="z.B. Techno, Rap" title="Neue Über-Kategorie"/>
          <button class="btn inline" id="addCatBtn">Anlegen</button>
        </div>
        <label for="catSel">Kategorie wählen</label>
        <select id="catSel" title="Kategorie auswählen"></select>
        <div class="row" style="justify-content:space-between;margin-top:6px">
          <button class="btn inline warn" id="delCatBtn">Kategorie löschen</button>
          <span class="muted">Kategorien: <strong id="countCats">0</strong></span>
        </div>
      </div>
      <div class="panel pad">
        <div class="title">Zufall (Genres & Moods)</div>
        <label for="randCatSel">Kategorie</label>
        <select id="randCatSel" title="Kategorie für Zufall"></select>
        <div class="row" style="gap:6px;margin-top:6px;flex-wrap:wrap">
          <button class="btn inline" data-g="3" data-m="3">3/3</button>
          <button class="btn inline" data-g="6" data-m="6">6/6</button>
          <button class="btn inline" data-g="9" data-m="6">9/6</button>
          <button class="btn inline" data-g="12" data-m="9">12/9</button>
          <button class="btn inline" data-g="15" data-m="12">15/12</button>
        </div>
        <div class="row" style="gap:6px;margin-top:6px">
          <input id="randG" type="number" min="1" value="4" title="Anzahl Genres"/>
          <input id="randM" type="number" min="1" value="4" title="Anzahl Moods"/>
          <button class="btn inline" id="randGo">Los</button>
          <button class="btn inline" id="copyOut">In Zwischenablage</button>
        </div>
        <textarea id="randOut" rows="4" placeholder="Ausgabe…" title="Zufalls-Ausgabe" readonly></textarea>
      </div>
    </div>
  </footer>
</div>
<div id="helpOverlay" class="help-overlay" hidden>
  <div id="helpDialog" class="help-dialog" role="dialog" aria-modal="true" aria-labelledby="helpTitle" tabindex="-1">
    <div class="help-header">
      <h2 class="title" id="helpTitle">Hilfe-Center für Einsteiger</h2>
      <button type="button" class="btn inline" id="helpCloseBtn" aria-label="Hilfe schließen (Esc)">Schließen ✖</button>
    </div>
    <p class="help-intro">Kurze Schritte ohne Fachsprache. Begriffe werden in Klammern erklärt.</p>
    <div class="help-shortcuts" aria-label="Wichtige Tastenkürzel">
      <span class="help-badge"><strong>F1</strong> Hilfe öffnen</span>
      <span class="help-badge"><strong>Strg + K</strong> Suche (Suchfeld) öffnen</span>
      <span class="help-badge"><strong>Strg + S</strong> Speichern (Sicherung) starten</span>
    </div>
    <p class="help-stats" id="helpStats">Aktueller Stand: –</p>
    <div id="helpTopicList" class="col" role="list" aria-live="polite"></div>
    <div class="help-footer">
      <button type="button" class="btn inline" id="helpCopyBtn">Spickzettel kopieren</button>
      <button type="button" class="btn inline" id="helpDownloadBtn">Spickzettel speichern</button>
    </div>
  </div>
</div>
<div id="configOverlay" class="config-overlay" hidden>
  <div id="configDialog" class="config-dialog" role="dialog" aria-modal="true" aria-labelledby="configTitle" tabindex="-1">
    <div class="config-header">
      <h2 class="title" id="configTitle">Konfigurations-Assistent für Laien</h2>
      <button type="button" class="btn inline" id="configCloseBtn" aria-label="Konfiguration schließen (Esc)">Schließen ✖</button>
    </div>
    <p class="config-intro">Wähle ein Paket oder passe einzelne Schalter an. Fachbegriffe stehen in Klammern und sind kurz erklärt.</p>
    <section class="config-section" aria-label="Empfohlene Pakete">
      <h3 class="title" style="margin:0;font-size:1.05rem;">Empfohlene Pakete</h3>
      <div class="config-presets" id="configPresetList">
        <button type="button" class="btn inline" data-preset="balanced">Allround</button>
        <button type="button" class="btn inline" data-preset="accessibility">Barrierefrei</button>
        <button type="button" class="btn inline" data-preset="focus">Fokus</button>
        <button type="button" class="btn inline" data-preset="performance">Performance</button>
      </div>
      <p class="muted" id="configPresetHint">Allround: Sicheres Standard-Paket mit automatischem Speichern und System-Einstellungen.</p>
    </section>
    <section class="config-section" aria-label="Feineinstellungen">
      <h3 class="title" style="margin:0;font-size:1.05rem;">Feineinstellungen</h3>
      <div class="config-grid">
        <div class="config-card" aria-label="Farbschema">
          <h4 class="title" style="margin:0;font-size:1rem;">Farbschema (Theme)</h4>
          <p>Ein Klick stellt Farben und Kontraste passend ein.</p>
          <div class="config-button-row" id="configThemeButtons">
            <button type="button" class="btn inline" data-theme="neo">Neo</button>
            <button type="button" class="btn inline" data-theme="paper">Paper</button>
            <button type="button" class="btn inline" data-theme="night">Night</button>
            <button type="button" class="btn inline" data-theme="forest">Forest</button>
            <button type="button" class="btn inline" data-theme="aurora">Aurora</button>
          </div>
        </div>
        <div class="config-card" aria-label="Schriftgröße">
          <h4 class="title" style="margin:0;font-size:1rem;">Schriftgröße</h4>
          <p>Feiner Text = 14 px, Standard = 16 px, größer = 18/20 px.</p>
          <div class="config-button-row" id="configFontButtons">
            <button type="button" class="btn inline" data-font="14">14 px</button>
            <button type="button" class="btn inline" data-font="16">16 px</button>
            <button type="button" class="btn inline" data-font="18">18 px</button>
            <button type="button" class="btn inline" data-font="20">20 px</button>
          </div>
        </div>
        <div class="config-card" aria-label="Sicherheit und Speicher">
          <h4 class="title" style="margin:0;font-size:1rem;">Sicherheit &amp; Speicher</h4>
          <label><input type="checkbox" id="configAutosave"> Autospeichern (speichert automatisch)</label>
          <label><input type="checkbox" id="configSelfrepair"> Self-Repair (Selbstheilung bei Fehlern)</label>
          <label><input type="checkbox" id="configToasts"> Hinweis-Popups (Toast-Meldungen)</label>
        </div>
        <div class="config-card" aria-label="Barrierefreiheit">
          <h4 class="title" style="margin:0;font-size:1rem;">Barrierefreiheit &amp; Komfort</h4>
          <label><input type="checkbox" id="configSystemMotion"> System-Animationen übernehmen</label>
          <label><input type="checkbox" id="configReduceMotion"> Animationen reduzieren</label>
          <label><input type="checkbox" id="configSystemContrast"> System-Kontrast übernehmen</label>
          <label><input type="checkbox" id="configHighContrast"> Hoher Kontrast erzwingen</label>
        </div>
      </div>
    </section>
    <section class="config-section" aria-label="Aktuelle Auswahl">
      <h3 class="title" style="margin:0;font-size:1.05rem;">Aktuelle Auswahl</h3>
      <ul class="config-list" id="configSummaryList"></ul>
    </section>
    <div class="config-footer">
      <button type="button" class="btn inline" id="configApplyBtn">Fertig – Assistent schließen</button>
      <button type="button" class="btn inline warn" id="configResetBtn">Zurück auf Standard</button>
    </div>
  </div>
</div>
<script>
(function(){
  'use strict';
  const docEl=typeof document!=='undefined'?document.documentElement:null;
  const supportsMatchMedia=typeof window!=='undefined'&&typeof window.matchMedia==='function';
  const reducedMotionMedia=supportsMatchMedia?window.matchMedia('(prefers-reduced-motion: reduce)'):null;
  const prefersContrastMedia=supportsMatchMedia?window.matchMedia('(prefers-contrast: more)'):null;
  const forcedColorsMedia=supportsMatchMedia?window.matchMedia('(forced-colors: active)'):null;
  const systemReduceDefault=reducedMotionMedia&&typeof reducedMotionMedia.matches==='boolean'?reducedMotionMedia.matches:false;
  const systemContrastDefault=(prefersContrastMedia&&typeof prefersContrastMedia.matches==='boolean'?prefersContrastMedia.matches:false)||(forcedColorsMedia&&typeof forcedColorsMedia.matches==='boolean'?forcedColorsMedia.matches:false);
  const isTestEnv=typeof window!=='undefined'&&window.__MODUL_TOOL_TEST__===true;
  const $=s=>document.querySelector(s);const $$=s=>Array.from(document.querySelectorAll(s));
  const loglist=$('#loglist');
  const liveRegion=$('#liveStatus');
  const liveText=$('#liveStatusText');
  const processLive=$('#processStatusLive');
  const processText=$('#processStatusText');
  const helpOverlay=$('#helpOverlay');
  const helpDialog=$('#helpDialog');
  const helpTopicList=$('#helpTopicList');
  const helpCopyBtn=$('#helpCopyBtn');
  const helpDownloadBtn=$('#helpDownloadBtn');
  const helpCloseBtn=$('#helpCloseBtn');
  const helpStats=$('#helpStats');
  const configOverlay=$('#configOverlay');
  const configDialog=$('#configDialog');
  const configCloseBtn=$('#configCloseBtn');
  const configPresetList=$('#configPresetList');
  const configPresetHint=$('#configPresetHint');
  const configThemeButtons=$$('#configThemeButtons button[data-theme]');
  const configFontButtons=$$('#configFontButtons button[data-font]');
  const configAutosave=$('#configAutosave');
  const configSelfrepair=$('#configSelfrepair');
  const configToasts=$('#configToasts');
  const configSystemMotion=$('#configSystemMotion');
  const configReduceMotion=$('#configReduceMotion');
  const configSystemContrast=$('#configSystemContrast');
  const configHighContrast=$('#configHighContrast');
  const configSummary=$('#configSummary');
  const configSummaryList=$('#configSummaryList');
  const configApplyBtn=$('#configApplyBtn');
  const configResetBtn=$('#configResetBtn');
  const systemMotionChk=$('#systemMotionChk');
  const reduceMotionChk=$('#reduceMotionChk');
  const systemContrastChk=$('#systemContrastChk');
  const highContrastChk=$('#highContrastChk');
  const fontScaleSel=$('#fontScaleSel');
  let lastConfigFocus=null;
  let isApplyingPreset=false;
  const safeStr=v=>v==null?'':String(v);const safeLower=v=>safeStr(v).toLowerCase();
  const escapeHtml=str=>safeStr(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  const ALLOWED_TAGS=new Set(['a','abbr','b','blockquote','br','code','em','i','li','ol','p','pre','small','span','strong','u','ul']);
  const ALLOWED_ATTRS={a:['href','title','target','rel'],code:['class'],pre:['class'],span:['class','data-label']};
  const URL_ATTRS=new Set(['href']);
  const SANITIZE_BASE_ORIGIN=(typeof location!=='undefined'&&location.origin)||'https://modultool.local';
  function sanitizeHtml(html){
    const markup=safeStr(html);
    if(!markup.trim())return '';
    const template=document.createElement('template');
    template.innerHTML=markup;
    const nodes=Array.from(template.content.querySelectorAll('*'));
    nodes.forEach(node=>{
      const tag=node.tagName.toLowerCase();
      if(!ALLOWED_TAGS.has(tag)){
        while(node.firstChild){node.parentNode.insertBefore(node.firstChild,node);}node.remove();
        return;
      }
      Array.from(node.attributes).forEach(attr=>{
        const name=attr.name.toLowerCase();
        if(name.startsWith('on')||name==='style'){node.removeAttribute(attr.name);return;}
        const allowedForTag=ALLOWED_ATTRS[tag]||[];
        if(!allowedForTag.includes(name)){node.removeAttribute(attr.name);return;}
        if(URL_ATTRS.has(name)){
          try{
            const parsed=new URL(node.getAttribute(attr.name),SANITIZE_BASE_ORIGIN);
            if(!['http:','https:','mailto:'].includes(parsed.protocol)){node.removeAttribute(attr.name);return;}
          }catch{node.removeAttribute(attr.name);return;}
          if(name==='href'&&!node.hasAttribute('target')){node.setAttribute('target','_blank');}
          if(name==='href'){node.setAttribute('rel','noopener noreferrer');}
        }
      });
    });
    return template.innerHTML;
  }
  const STATUS_TYPES=new Set(['info','ok','warn','error']);
  const LOG_LEVELS=Object.freeze({
    info:{label:'Info',icon:'ℹ️'},
    ok:{label:'Erfolg',icon:'✅'},
    warn:{label:'Hinweis',icon:'⚠️'},
    error:{label:'Fehler',icon:'⛔'}
  });
  const DEFAULT_LOG_LEVEL='info';
  const KNOWN_LOG_LEVELS=new Set(Object.keys(LOG_LEVELS));
  const THEME_LABELS=Object.freeze({neo:'Neo',paper:'Paper',night:'Night HighContrast',forest:'Forest',aurora:'Aurora'});
  const CONFIG_PRESETS=Object.freeze({
    balanced:{
      id:'balanced',
      label:'Allround',
      description:'Allround: Sicheres Standard-Paket mit automatischem Speichern und System-Einstellungen.',
      settings:{
        theme:'neo',
        autosave:true,
        selfrepair:true,
        toasts:true,
        respectSystemMotion:true,
        reduceMotion:false,
        respectSystemContrast:true,
        highContrast:false,
        fontScale:16
      }
    },
    accessibility:{
      id:'accessibility',
      label:'Barrierefrei',
      description:'Barrierefrei: Große Schrift, reduziertes Blinken und hoher Kontrast für bestmögliche Lesbarkeit.',
      settings:{
        theme:'paper',
        autosave:true,
        selfrepair:true,
        toasts:true,
        respectSystemMotion:false,
        reduceMotion:true,
        respectSystemContrast:false,
        highContrast:true,
        fontScale:18
      }
    },
    focus:{
      id:'focus',
      label:'Fokus',
      description:'Fokus: Dunkles Bild mit hohem Kontrast, wenig Popups und ruhige Animationen für konzentriertes Arbeiten.',
      settings:{
        theme:'night',
        autosave:true,
        selfrepair:true,
        toasts:false,
        respectSystemMotion:false,
        reduceMotion:true,
        respectSystemContrast:false,
        highContrast:true,
        fontScale:18
      }
    },
    performance:{
      id:'performance',
      label:'Performance',
      description:'Performance: Schlanke Rückmeldungen, reduzierte Effekte und Standardgröße für maximale Geschwindigkeit.',
      settings:{
        theme:'neo',
        autosave:true,
        selfrepair:true,
        toasts:false,
        respectSystemMotion:false,
        reduceMotion:true,
        respectSystemContrast:false,
        highContrast:false,
        fontScale:16
      }
    },
    custom:{
      id:'custom',
      label:'Eigenes Paket',
      description:'Eigenes Paket: Einstellungen wurden manuell angepasst.',
      settings:{}
    }
  });
  const CONFIG_PRESET_SEQUENCE=['balanced','accessibility','focus','performance'];
  function normalizeLogType(type){const key=safeLower(type);return KNOWN_LOG_LEVELS.has(key)?key:DEFAULT_LOG_LEVEL;}
  function announce(message,type='info'){
    const text=safeStr(message).trim()||'Bereit.';
    const statusType=STATUS_TYPES.has(type)?type:'info';
    if(liveRegion){
      liveRegion.textContent=text;
      liveRegion.setAttribute('data-last-type',statusType);
    }
    if(liveText){
      liveText.dataset.type=statusType;
      liveText.textContent='Status: '+text;
    }
  }
  function announceProcess(message,type='info',priority='polite'){
    const text=safeStr(message).trim()||'Bereit.';
    const statusType=STATUS_TYPES.has(type)?type:'info';
    const politeness=safeLower(priority)==='assertive'?'assertive':'polite';
    if(processLive){
      processLive.textContent=text;
      processLive.setAttribute('data-last-type',statusType);
      processLive.setAttribute('aria-live',politeness);
    }
    if(processText){
      processText.dataset.type=statusType;
      processText.textContent='Prozessstatus: '+text;
    }
  }
  function highlightElement(el){
    if(!el||!el.classList)return;
    el.classList.add('focus-ring');
    setTimeout(()=>el.classList.remove('focus-ring'),1500);
  }
  function focusAndAnnounce(selector,message){
    const target=selector?document.querySelector(selector):null;
    if(!target)return false;
    highlightElement(target);
    if(typeof target.focus==='function'){
      try{target.focus({preventScroll:true});}catch{}
    }
    if(message) announceProcess(message,'info');
    return true;
  }
  function isHelpOpen(){return !!(helpOverlay&&!helpOverlay.hasAttribute('hidden'));}
  function updateHelpStats(){
    if(!helpStats)return;
    const stats=`Aktueller Stand: ${state.modules.length} Module, ${state.plugins.length} Plugins, ${state.playlist.length} Titel, ${state.genres.length} Genres, ${state.moods.length} Moods.`;
    helpStats.textContent=stats;
  }
  function buildHelpPlainText(){
    const lines=['ModulTool – Hilfe-Center',`Aktueller Stand: ${state.modules.length} Module, ${state.plugins.length} Plugins, ${state.playlist.length} Titel, ${state.genres.length} Genres, ${state.moods.length} Moods.`, ''];
    helpTopics.forEach(topic=>{
      lines.push(topic.title);
      lines.push(topic.description);
      if(Array.isArray(topic.steps)&&topic.steps.length){
        topic.steps.forEach((step,idx)=>{
          const hint=step.hint?` (${step.hint})`:'';
          lines.push(` ${idx+1}. ${step.text}${hint}`);
        });
      }
      if(Array.isArray(topic.tips)&&topic.tips.length){
        lines.push(' Tipps:');
        topic.tips.forEach(tip=>lines.push('  - '+tip));
      }
      if(Array.isArray(topic.actions)&&topic.actions.length){
        lines.push(' Aktionen:');
        topic.actions.forEach(action=>lines.push('  - '+action.label+(action.description?': '+action.description:'')));
      }
      lines.push('');
    });
    return lines.join('\n');
  }
  function openHelp(topicId){
    if(!helpOverlay||!helpDialog)return;
    const alreadyOpen=isHelpOpen();
    if(!alreadyOpen){
      lastHelpFocus=document.activeElement;
      helpOverlay.removeAttribute('hidden');
      helpDialog.setAttribute('aria-hidden','false');
      document.body.classList.add('help-open');
      requestAnimationFrame(()=>{try{helpDialog.focus({preventScroll:true});}catch{}});
      updateHelpStats();
      announceProcess('Hilfe geöffnet. Folge den einfachen Schritt-für-Schritt-Erklärungen.','info');
      addLog('info','Hilfe geöffnet.');
    }
    if(topicId&&helpTopicList){
      const safeId=typeof CSS!=='undefined'&&CSS.escape?CSS.escape(topicId):String(topicId).replace(/"/g,'\\"');
      const selector=`[data-topic-id="${safeId}"]`;
      const card=helpTopicList.querySelector(selector);
      if(card){
        if(typeof card.scrollIntoView==='function'){
          card.scrollIntoView({block:'start',behavior:isReduceMotionActive()?'auto':'smooth'});
        }
        const heading=card.querySelector('h3');
        if(heading){
          heading.setAttribute('tabindex','-1');
          try{heading.focus({preventScroll:true});}catch{}
          setTimeout(()=>heading.removeAttribute('tabindex'),250);
        }
      }
    }
  }
  function closeHelp(){
    if(!isHelpOpen())return;
    helpOverlay.setAttribute('hidden','');
    helpDialog.setAttribute('aria-hidden','true');
    document.body.classList.remove('help-open');
    announceProcess('Hilfe geschlossen.','info');
    addLog('info','Hilfe geschlossen.');
    const focusTarget=lastHelpFocus;
    lastHelpFocus=null;
    if(focusTarget&&typeof focusTarget.focus==='function'){
      try{focusTarget.focus({preventScroll:true});}catch{}
    }
  }
  function renderHelpTopics(){
    if(!helpTopicList)return;
    helpTopicList.innerHTML='';
    const frag=document.createDocumentFragment();
    helpTopics.forEach(topic=>{
      const card=document.createElement('article');
      card.className='help-topic';
      card.setAttribute('role','listitem');
      card.dataset.topicId=topic.id;
      const heading=document.createElement('h3');
      heading.textContent=topic.title;
      card.appendChild(heading);
      const desc=document.createElement('p');
      desc.className='muted';
      desc.textContent=topic.description;
      card.appendChild(desc);
      if(Array.isArray(topic.steps)&&topic.steps.length){
        const list=document.createElement('ol');
        list.className='help-steps';
        topic.steps.forEach(step=>{
          const li=document.createElement('li');
          li.textContent=step.text;
          if(step.hint){
            const hint=document.createElement('p');
            hint.textContent=step.hint;
            li.appendChild(hint);
          }
          list.appendChild(li);
        });
        card.appendChild(list);
      }
      if(Array.isArray(topic.shortcuts)&&topic.shortcuts.length){
        const shortWrap=document.createElement('div');
        shortWrap.className='help-shortcuts';
        topic.shortcuts.forEach(shortcut=>{
          const badge=document.createElement('span');
          badge.className='help-badge';
          const strong=document.createElement('strong');
          strong.textContent=shortcut.combo;
          badge.appendChild(strong);
          badge.appendChild(document.createTextNode(' '+shortcut.note));
          shortWrap.appendChild(badge);
        });
        card.appendChild(shortWrap);
      }
      if(Array.isArray(topic.actions)&&topic.actions.length){
        const actionsWrap=document.createElement('div');
        actionsWrap.className='help-actions';
        topic.actions.forEach(action=>{
          const row=document.createElement('div');
          row.className='help-action';
          const btn=document.createElement('button');
          btn.type='button';
          btn.className='btn inline';
          btn.textContent=action.label;
          btn.addEventListener('click',()=>{
            let result=true;
            try{
              if(typeof action.run==='function'){
                result=action.run();
              }
            }catch(err){
              result=false;
              const msg=err&&err.message?err.message:String(err);
              addLog('warn','Hilfe-Aktion fehlgeschlagen: '+msg);
              announceProcess('Hilfe-Aktion fehlgeschlagen. Sieh ins Log.','warn');
            }
            if(action.closeAfter&&result!==false){
              closeHelp();
            }
          });
          row.appendChild(btn);
          if(action.description){
            const hint=document.createElement('span');
            hint.className='muted';
            hint.textContent=action.description;
            row.appendChild(hint);
          }
          actionsWrap.appendChild(row);
        });
        card.appendChild(actionsWrap);
      }
      if(Array.isArray(topic.tips)&&topic.tips.length){
        const tipsList=document.createElement('ul');
        tipsList.className='help-tips';
        topic.tips.forEach(tip=>{
          const li=document.createElement('li');
          li.textContent=tip;
          tipsList.appendChild(li);
        });
        card.appendChild(tipsList);
      }
      frag.appendChild(card);
    });
    helpTopicList.appendChild(frag);
  }
  function copyHelpNotes(){
    const text=buildHelpPlainText();
    const fallback=()=>{
      const temp=document.createElement('textarea');
      temp.value=text;
      temp.setAttribute('aria-hidden','true');
      temp.style.position='fixed';
      temp.style.opacity='0';
      document.body.appendChild(temp);
      temp.select();
      try{
        document.execCommand('copy');
        toast('Spickzettel kopiert.');
        addLog('ok','Hilfe-Spickzettel kopiert.');
        announceProcess('Spickzettel kopiert.','ok');
      }catch(err){
        addLog('warn','Kopieren nicht möglich: '+(err&&err.message?err.message:String(err)));
        announceProcess('Kopieren nicht möglich. Bitte Text manuell markieren.','warn');
      }finally{
        temp.remove();
      }
    };
    if(navigator.clipboard&&window.isSecureContext){
      navigator.clipboard.writeText(text).then(()=>{
        toast('Spickzettel kopiert.');
        addLog('ok','Hilfe-Spickzettel kopiert.');
        announceProcess('Spickzettel kopiert.','ok');
      }).catch(()=>fallback());
    }else{
      fallback();
    }
  }
  function downloadHelpNotes(){
    const text=buildHelpPlainText();
    download('modultool-hilfe.txt',text);
    addLog('ok','Hilfe-Spickzettel gespeichert.');
    announceProcess('Hilfe als Text gespeichert.','ok');
  }
  function createHelpTopics(){
    return[
      {
        id:'quickstart',
        title:'Schnell loslegen',
        description:'Drei einfache Schritte reichen, um dein erstes Modul anzuzeigen.',
        steps:[
          {text:'Blende die linke Seitenleiste ein, falls sie fehlt. Klicke dazu auf „⟷ Links“.',hint:'So siehst du alle vorhandenen Module.'},
          {text:'Trage einen Namen in „Neues Modul“ ein und bestätige mit Enter oder dem Button „Hinzufügen“.',hint:'Das Modul erscheint sofort in der Liste.'},
          {text:'Klicke den neuen Listeneintrag an, damit der Arbeitsbereich in der Mitte geladen wird.'}
        ],
        actions:[
          {label:'Feld „Neues Modul“ anzeigen',description:'Blendet die linke Leiste ein und setzt den Cursor in das Eingabefeld.',run:()=>{document.body.classList.remove('collapsed-left');return focusAndAnnounce('#newModuleName','Feld „Neues Modul“ aktiv.');}},
          {label:'Suche öffnen',description:'Aktiviert das Suchfeld (entspricht Strg+K).',run:()=>{document.body.classList.remove('collapsed-left');return focusAndAnnounce('#quickSearch','Suchfeld geöffnet.');}},
          {label:'Start-Hinweise anzeigen',description:'Öffnet das Start-Modul mit einer kompakten Übersicht.',run:()=>{openModule(startId);announceProcess('Start-Hinweise angezeigt.','info');return true;},closeAfter:true}
        ],
        tips:[
          'Autospeichern läuft automatisch. Entferne bei Bedarf den Haken „Autospeichern“. ',
          'Nutze kurze Modulnamen. So findest du Inhalte später schneller über die Suche.'
        ]
      },
      {
        id:'modulePlugins',
        title:'Module erweitern & Plugins nutzen',
        description:'So verbindest du Module mit Plugins (Zusatzfunktionen).',
        steps:[
          {text:'Öffne einen Moduleintrag, damit er im Arbeitsbereich erscheint.',hint:'Jedes Modul kann eigene Inhalte oder Plugins aufnehmen.'},
          {text:'Verwende das Modul „Plugin-Manager“, um eine Plugin-Datei (JSON = Textdatei für Daten) zu importieren.',hint:'Das Tool prüft die Datei und zeigt sichere Inhalte in einer Sandbox (geschütztes Fenster) an.'},
          {text:'Nach dem Import findest du das Plugin als eigenes Modul in der Liste und kannst es jederzeit entfernen.'}
        ],
        actions:[
          {label:'Plugin-Manager öffnen',description:'Springt zum Modul für Import, Export und Entfernen.',run:()=>{openModule(pluginOverviewId);announceProcess('Plugin-Manager geöffnet.','info');return true;},closeAfter:true},
          {label:'Plugin-Liste leeren',description:'Entfernt alle geladenen Plugins (Reset).',run:()=>{clearPlugins();announceProcess('Alle Plugins entfernt.','warn');addLog('warn','Hilfe: Alle Plugins entfernt.');return true;}},
          {label:'Selbsttest starten',description:'Prüft Tastaturkürzel, Backup und Plugins automatisch.',run:()=>{closeHelp();runSelfTests();return true;},closeAfter:false}
        ],
        tips:[
          'Importiere Plugins nur aus vertrauenswürdigen Quellen. Das Log meldet Erfolg oder Fehler.',
          'Mit dem Button „Manifest“ erhältst du eine Übersicht aller Module und Plugins als Textdatei.'
        ]
      },
      {
        id:'audio',
        title:'Audio & Playlist bedienen',
        description:'Steuere Musik komplett per Maus oder Tastatur.',
        steps:[
          {text:'Ziehe Audiodateien per Drag & Drop in die Dropzone oder klicke darauf und wähle Dateien aus.',hint:'Die Dropzone liegt im rechten Bereich. Du kannst auch die Tastatur verwenden (Enter oder Leertaste).'},
          {text:'Markiere einen Titel in der Liste und drücke Enter. Mit Alt + Pfeilen sortierst du die Reihenfolge.',hint:'Entf löscht einen Eintrag, ohne den Rest zu verändern.'},
          {text:'Nutze „Export“, um die Playlist als Datei zu sichern, oder „Import“, um eine gespeicherte Liste zu laden.'}
        ],
        actions:[
          {label:'Audiofläche hervorheben',description:'Blendet die rechte Leiste ein und markiert die Dropzone.',run:()=>{document.body.classList.remove('collapsed-right');return focusAndAnnounce('#dropzone','Audio-Dropzone bereit.');}},
          {label:'Playlist importieren',description:'Öffnet den Dateidialog zum Laden einer gespeicherten Playlist (JSON).',run:()=>{document.body.classList.remove('collapsed-right');const btn=$('#impPlBtn');if(btn){btn.click();announceProcess('Wähle nun deine Playlist-Datei aus.','info');return true;}announceProcess('Import-Button nicht gefunden.','warn');return false;},closeAfter:true},
          {label:'Playlist exportieren',description:'Speichert die aktuelle Playlist als Datei.',run:()=>{exportPlaylist();announceProcess('Playlist exportiert.','ok');return true;},closeAfter:false}
        ],
        shortcuts:[
          {combo:'Enter',note:'Titel starten'},
          {combo:'Alt + Pfeil↑/↓',note:'Titel verschieben'},
          {combo:'Entf',note:'Titel löschen'}
        ],
        tips:[
          'Die Statuszeile unter dem Player zeigt Interpret und Titel an.',
          'Mit „⏮“ und „⏭“ springst du zum vorherigen oder nächsten Titel.'
        ]
      },
      {
        id:'safety',
        title:'Sichern & Probleme lösen',
        description:'So behältst du jederzeit eine funktionierende Sicherung (Backup = Sicherheitskopie).',
        steps:[
          {text:'Klicke auf „Export“, um eine komplette Sicherung (JSON) zu speichern.',hint:'Die Datei enthält Module, Playlist, Plugins und Einstellungen.'},
          {text:'Öffne das Modul „Backup-Prüfung“, prüfe eine Datei und lies das Ergebnis im Statusfeld.',hint:'Fehler werden erklärt und können anschließend korrigiert werden.'},
          {text:'Aktiviere und starte „Self-Repair“, falls etwas nicht stimmt. Das Tool korrigiert Duplikate und IDs.'}
        ],
        actions:[
          {label:'Backup exportieren',description:'Erstellt sofort eine Sicherungsdatei.',run:()=>{exportAll();return true;},closeAfter:false},
          {label:'Backup-Prüfung öffnen',description:'Springt direkt in das Prüfmodul.',run:()=>{openModule(backupCheckId);announceProcess('Backup-Prüfung geöffnet.','info');return true;},closeAfter:true},
          {label:'Self-Repair jetzt ausführen',description:'Bereinigt Daten sofort und meldet die Anzahl der Korrekturen.',run:()=>{const fixes=selfRepair();renderAll();persist();announceProcess(`Self-Repair abgeschlossen (${fixes} Korrekturen).`,fixes>0?'ok':'info');addLog('info','Hilfe: Self-Repair ausgelöst.');return true;},closeAfter:false}
        ],
        tips:[
          'Self-Repair meldet jede Änderung im Log. So erkennst du, was angepasst wurde.',
          'Bewahre Sicherungsdateien an einem sicheren Ort auf (z. B. externes Laufwerk).' 
        ]
      }
    ];
  }
  const allowedFontScales=new Set([14,16,18,20]);
  function readSystemMotion(){
    return reducedMotionMedia&&typeof reducedMotionMedia.matches==='boolean'?reducedMotionMedia.matches:false;
  }
  function readSystemContrast(){
    const mediaContrast=prefersContrastMedia&&typeof prefersContrastMedia.matches==='boolean'?prefersContrastMedia.matches:false;
    const forcedActive=forcedColorsMedia&&typeof forcedColorsMedia.matches==='boolean'?forcedColorsMedia.matches:false;
    return mediaContrast||forcedActive;
  }
  function isReduceMotionActive(){
    if(state.respectSystemMotion){
      return readSystemMotion();
    }
    return !!state.reduceMotion;
  }
  function isHighContrastActive(){
    if(state.respectSystemContrast){
      return readSystemContrast();
    }
    return !!state.highContrast;
  }
  function applyMotionPreference(){
    if(docEl){
      docEl.setAttribute('data-motion',isReduceMotionActive()?'reduced':'full');
    }
  }
  function applyContrastPreference(){
    if(docEl){
      docEl.setAttribute('data-contrast',isHighContrastActive()?'high':'normal');
    }
  }
  function applyFontScale(){
    const size=allowedFontScales.has(Number(state.fontScale))?Number(state.fontScale):16;
    if(docEl){
      docEl.style.setProperty('--font-size',size+'px');
    }
    if(document&&document.body){
      if(size>=18){document.body.classList.add('font-large');}
      else{document.body.classList.remove('font-large');}
    }
  }
  function applyDisplayPreferences(){
    applyMotionPreference();
    applyContrastPreference();
    applyFontScale();
  }
  function renderDisplaySettings(){
    if(systemMotionChk){
      systemMotionChk.checked=!!state.respectSystemMotion;
    }
    if(reduceMotionChk){
      reduceMotionChk.checked=state.respectSystemMotion?readSystemMotion():!!state.reduceMotion;
      reduceMotionChk.disabled=!!state.respectSystemMotion;
      reduceMotionChk.setAttribute('aria-disabled',state.respectSystemMotion?'true':'false');
    }
    if(systemContrastChk){
      systemContrastChk.checked=!!state.respectSystemContrast;
    }
    if(highContrastChk){
      highContrastChk.checked=state.respectSystemContrast?readSystemContrast():!!state.highContrast;
      highContrastChk.disabled=!!state.respectSystemContrast;
      highContrastChk.setAttribute('aria-disabled',state.respectSystemContrast?'true':'false');
    }
    if(fontScaleSel){
      const value=allowedFontScales.has(Number(state.fontScale))?String(Number(state.fontScale)):String(systemFontDefault());
      fontScaleSel.value=value;
    }
    syncConfigOverlay();
  }
  function systemFontDefault(){
    return 16;
  }
  function bindMediaListeners(){
    const handleMotionChange=()=>{
      if(state.respectSystemMotion){
        applyMotionPreference();
        renderDisplaySettings();
        announce('System-Animationseinstellung übernommen.','info');
      }
    };
    const handleContrastChange=()=>{
      if(state.respectSystemContrast){
        applyContrastPreference();
        renderDisplaySettings();
        announce('System-Kontrasteinstellung übernommen.','info');
      }
    };
    if(reducedMotionMedia){
      if(typeof reducedMotionMedia.addEventListener==='function'){reducedMotionMedia.addEventListener('change',handleMotionChange);}else if(typeof reducedMotionMedia.addListener==='function'){reducedMotionMedia.addListener(handleMotionChange);}
    }
    if(prefersContrastMedia){
      if(typeof prefersContrastMedia.addEventListener==='function'){prefersContrastMedia.addEventListener('change',handleContrastChange);}else if(typeof prefersContrastMedia.addListener==='function'){prefersContrastMedia.addListener(handleContrastChange);}
    }
    if(forcedColorsMedia){
      if(typeof forcedColorsMedia.addEventListener==='function'){forcedColorsMedia.addEventListener('change',handleContrastChange);}else if(typeof forcedColorsMedia.addListener==='function'){forcedColorsMedia.addListener(handleContrastChange);}
    }
  }
  const FALLBACK_THEME={
    text:'#111827',
    panel:'#ffffff',
    panelSoft:'#f1f5fb',
    accent:'#2563eb',
    link:'#1d4ed8',
    muted:'#6b7280',
    font:'system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Cantarell,"Noto Sans",Arial,sans-serif'
  };
  function readThemeVar(styles,name,fallback){
    if(!styles)return fallback;
    const value=styles.getPropertyValue(name);
    return value&&value.trim()?value.trim():fallback;
  }
  function getThemeTokens(){
    if(typeof window==='undefined'||typeof window.getComputedStyle!=='function'){
      return Object.assign({},FALLBACK_THEME);
    }
    const styles=getComputedStyle(document.documentElement);
    return{
      text:readThemeVar(styles,'--text',FALLBACK_THEME.text),
      panel:readThemeVar(styles,'--panel',FALLBACK_THEME.panel),
      panelSoft:readThemeVar(styles,'--panel-2',FALLBACK_THEME.panelSoft),
      accent:readThemeVar(styles,'--accent',FALLBACK_THEME.accent),
      link:readThemeVar(styles,'--link',FALLBACK_THEME.link),
      muted:readThemeVar(styles,'--muted',FALLBACK_THEME.muted),
      font:readThemeVar(styles,'--font',FALLBACK_THEME.font)
    };
  }
  function buildPluginSandboxDocument(contentHtml,tokens){
    const theme=tokens||getThemeTokens();
    const bodyContent=contentHtml&&contentHtml.trim()?contentHtml:'<p class="muted">Keine Inhalte.</p>';
    const fontFamily=theme.font||FALLBACK_THEME.font;
    return`<!DOCTYPE html><html lang="de"><head><meta charset="utf-8"><style>`+
      ':root{color-scheme:light dark;}'+
      `body{margin:0;padding:16px;background:${theme.panel};color:${theme.text};font-family:${fontFamily};line-height:1.6;word-break:break-word;}`+
      `a{color:${theme.link};text-decoration:underline;}`+
      `blockquote{border-left:4px solid ${theme.accent};margin:12px 0;padding:4px 12px;background:${theme.panelSoft};}`+
      `code,pre{background:${theme.panelSoft};color:${theme.text};border-radius:8px;padding:4px;}`+
      'pre{overflow:auto;}' +
      'ul,ol{padding-left:20px;}' +
      `.muted{color:${theme.muted};}`+
      'table{width:100%;border-collapse:collapse;}' +
      `td,th{border:1px solid ${theme.panelSoft};padding:6px;text-align:left;}`+
      '</style></head><body>'+bodyContent+'</body></html>';
  }
  function refreshPluginFrames(){
    const theme=getThemeTokens();
    $$('.plugin-frame').forEach(frame=>{
      const content=frame.dataset&&frame.dataset.content?frame.dataset.content:'';
      frame.setAttribute('srcdoc',buildPluginSandboxDocument(content,theme));
    });
  }
  const slugify=v=>safeLower(v).normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')||('item-'+Date.now());
  const uuid=()=>crypto&&crypto.randomUUID?crypto.randomUUID():'u'+Date.now()+Math.random().toString(16).slice(2);
  const state={version:'1.1.5',theme:'neo',autosave:true,selfrepair:true,toasts:true,respectSystemMotion:true,respectSystemContrast:true,reduceMotion:systemReduceDefault,highContrast:systemContrastDefault,fontScale:systemFontDefault(),configPreset:'balanced',modules:[],activeModule:null,categories:{},genres:[],moods:[],playlist:[],log:[],logFilter:'all',plugins:[],_currentIndex:null};
  function getPresetMeta(id){return CONFIG_PRESETS[id]||CONFIG_PRESETS.custom;}
  function findPresetMatch(snapshot){
    if(!snapshot)return null;
    const normalized={
      theme:safeStr(snapshot.theme).trim()||'neo',
      autosave:!!snapshot.autosave,
      selfrepair:!!snapshot.selfrepair,
      toasts:snapshot.toasts!==false,
      respectSystemMotion:snapshot.respectSystemMotion===undefined?true:!!snapshot.respectSystemMotion,
      reduceMotion:snapshot.reduceMotion===undefined?systemReduceDefault:!!snapshot.reduceMotion,
      respectSystemContrast:snapshot.respectSystemContrast===undefined?true:!!snapshot.respectSystemContrast,
      highContrast:snapshot.highContrast===undefined?systemContrastDefault:!!snapshot.highContrast,
      fontScale:allowedFontScales.has(Math.round(Number(snapshot.fontScale)||0))?Math.round(Number(snapshot.fontScale)||0):systemFontDefault()
    };
    for(const id of CONFIG_PRESET_SEQUENCE){
      const preset=CONFIG_PRESETS[id];
      const settings=preset.settings||{};
      let matches=true;
      for(const key of Object.keys(settings)){
        if(normalized[key]!==settings[key]){matches=false;break;}
      }
      if(matches){return id;}
    }
    return null;
  }
  function updateThemeButtons(activeTheme){
    const theme=activeTheme||state.theme;
    configThemeButtons.forEach(btn=>{btn.setAttribute('aria-pressed',btn.dataset.theme===theme?'true':'false');});
  }
  function updateFontButtons(activeFont){
    const font=allowedFontScales.has(Number(activeFont))?Number(activeFont):systemFontDefault();
    configFontButtons.forEach(btn=>{btn.setAttribute('aria-pressed',Number(btn.dataset.font)===font?'true':'false');});
  }
  function updateConfigPresetHint(forceId){
    const presetId=forceId||state.configPreset||'custom';
    const meta=getPresetMeta(presetId);
    if(configPresetHint){configPresetHint.textContent=meta.description;}
    if(configPresetList){
      $$('#configPresetList button[data-preset]').forEach(btn=>{btn.setAttribute('aria-pressed',btn.dataset.preset===presetId?'true':'false');});
    }
  }
  function buildConfigSummaryItems(){
    const presetMeta=getPresetMeta(state.configPreset);
    const themeLabel=THEME_LABELS[state.theme]||safeStr(state.theme||'Neo');
    const fontSize=allowedFontScales.has(Number(state.fontScale))?Number(state.fontScale):systemFontDefault();
    const autosaveText=state.autosave?'Autospeichern an (speichert automatisch)':'Autospeichern aus (manuell speichern)';
    const selfrepairText=state.selfrepair?'Self-Repair an (Tool heilt Fehler)':'Self-Repair aus (manuell prüfen)';
    const toastText=state.toasts!==false?'Hinweis-Popups an':'Hinweis-Popups aus';
    const motionText=state.respectSystemMotion?'Animationen folgen dem System':(state.reduceMotion?'Animationen reduziert':'Animationen normal');
    const contrastText=state.respectSystemContrast?'Kontrast folgt dem System':(state.highContrast?'Hoher Kontrast aktiv':'Normaler Kontrast');
    return[
      `Paket: ${presetMeta.label}`,
      `Farbschema: ${themeLabel}`,
      `Schriftgröße ${fontSize}\u202fpx`,
      autosaveText,
      selfrepairText,
      toastText,
      motionText,
      contrastText
    ];
  }
  function updateConfigSummary(){
    const items=buildConfigSummaryItems();
    if(configSummary){configSummary.textContent=items.join(' • ');}
    if(configSummaryList){
      configSummaryList.innerHTML='';
      const frag=document.createDocumentFragment();
      items.forEach(item=>{const li=document.createElement('li');li.textContent=item;frag.appendChild(li);});
      configSummaryList.appendChild(frag);
    }
  }
  function syncConfigOverlay(){
    if(configAutosave) configAutosave.checked=!!state.autosave;
    if(configSelfrepair) configSelfrepair.checked=!!state.selfrepair;
    if(configToasts) configToasts.checked=state.toasts!==false;
    if(configSystemMotion) configSystemMotion.checked=!!state.respectSystemMotion;
    if(configReduceMotion){
      const value=state.respectSystemMotion?readSystemMotion():!!state.reduceMotion;
      configReduceMotion.checked=value;
      configReduceMotion.disabled=!!state.respectSystemMotion;
      configReduceMotion.setAttribute('aria-disabled',state.respectSystemMotion?'true':'false');
    }
    if(configSystemContrast) configSystemContrast.checked=!!state.respectSystemContrast;
    if(configHighContrast){
      const value=state.respectSystemContrast?readSystemContrast():!!state.highContrast;
      configHighContrast.checked=value;
      configHighContrast.disabled=!!state.respectSystemContrast;
      configHighContrast.setAttribute('aria-disabled',state.respectSystemContrast?'true':'false');
    }
    updateThemeButtons(state.theme);
    updateFontButtons(state.fontScale);
    updateConfigPresetHint();
  }
  function isConfigOpen(){return !!(configOverlay&&!configOverlay.hasAttribute('hidden'));}
  function openConfigAssistant(presetId){
    if(!configOverlay||!configDialog)return;
    if(presetId&&CONFIG_PRESETS[presetId]){state.configPreset=presetId;}
    syncConfigOverlay();
    updateConfigSummary();
    configOverlay.removeAttribute('hidden');
    document.body.classList.add('config-open');
    lastConfigFocus=document.activeElement;
    setTimeout(()=>{try{configDialog.focus({preventScroll:true});}catch{/* ignore */}},0);
  }
  function closeConfigAssistant(){
    if(!configOverlay)return;
    configOverlay.setAttribute('hidden','');
    document.body.classList.remove('config-open');
    if(lastConfigFocus&&typeof lastConfigFocus.focus==='function'){
      setTimeout(()=>{try{lastConfigFocus.focus({preventScroll:true});}catch{/* ignore */}},0);
    }
  }
  function updateConfigPresetState(opts={}){
    if(isApplyingPreset)return;
    const prev=state.configPreset||'custom';
    const detected=findPresetMatch(state)||'custom';
    state.configPreset=detected;
    if(prev!==detected&&!opts.skipLog){
      if(detected==='custom'){addLog('info','Konfiguration angepasst.');}
      else{const meta=getPresetMeta(detected);addLog('ok','Preset erkannt: '+meta.label);}
    }
    updateConfigPresetHint(detected);
  }
  function handleSettingChanged(){
    updateConfigPresetState();
    syncConfigOverlay();
    updateConfigSummary();
  }
  function activateConfigPreset(id,{announceSelection=true}={}){
    if(!CONFIG_PRESETS[id]||id==='custom'){
      throw new Error('Unbekanntes Preset: '+id);
    }
    const preset=CONFIG_PRESETS[id];
    const settings=preset.settings||{};
    isApplyingPreset=true;
    try{
      const themeSel=$('#themeSel');
      if(themeSel&&settings.theme){
        if(themeSel.value!==settings.theme){
          themeSel.value=settings.theme;
          themeSel.dispatchEvent(new Event('change',{bubbles:true}));
        }
      }else if(settings.theme){
        state.theme=settings.theme;
        renderTheme();
      }
      const applyCheckbox=(selector,value)=>{
        const el=$(selector);
        if(!el)return;
        const desired=!!value;
        if(el.checked!==desired){
          el.checked=desired;
          el.dispatchEvent(new Event('change',{bubbles:true}));
        }
      };
      if('autosave' in settings){applyCheckbox('#autosaveChk',settings.autosave);}
      if('selfrepair' in settings){applyCheckbox('#selfrepairChk',settings.selfrepair);}
      if('toasts' in settings){applyCheckbox('#toastsChk',settings.toasts);}
      if('respectSystemMotion' in settings){applyCheckbox('#systemMotionChk',settings.respectSystemMotion);}
      if('reduceMotion' in settings){
        if(settings.respectSystemMotion===false){applyCheckbox('#systemMotionChk',false);}
        applyCheckbox('#reduceMotionChk',settings.reduceMotion);
      }
      if('respectSystemContrast' in settings){applyCheckbox('#systemContrastChk',settings.respectSystemContrast);}
      if('highContrast' in settings){
        if(settings.respectSystemContrast===false){applyCheckbox('#systemContrastChk',false);}
        applyCheckbox('#highContrastChk',settings.highContrast);
      }
      if('fontScale' in settings&&fontScaleSel){
        const desired=String(settings.fontScale);
        if(fontScaleSel.value!==desired){
          fontScaleSel.value=desired;
          fontScaleSel.dispatchEvent(new Event('change',{bubbles:true}));
        }
      }
    }finally{
      isApplyingPreset=false;
    }
    state.configPreset=id;
    updateConfigPresetHint(id);
    syncConfigOverlay();
    updateConfigSummary();
    if(announceSelection){
      addLog('ok','Preset „'+preset.label+'" aktiviert.');
      announceProcess('Preset „'+preset.label+'" aktiv.','ok');
    }
    return preset;
  }
  let clockTimer=null;
  const moduleRegistry=new Map();
  let helpTopics=[];
  let lastHelpFocus=null;
  const isPlainObject=value=>value&&typeof value==='object'&&!Array.isArray(value);
  const hasOwn=(obj,key)=>Object.prototype.hasOwnProperty.call(obj,key);
  const ensureArray=(value,path,errors)=>{if(!Array.isArray(value)){errors.push(path+' muss ein Array sein.');return [];}return value;};
  const ensureString=(value,path,min=0,allowEmpty=false)=>{if(typeof value!=='string'){return path+' muss ein String sein.';}if(!allowEmpty&&value.trim().length<min){return path+` benötigt mindestens ${min} Zeichen.`;}return null;};
  const ensureBoolean=(value,path,errors)=>{if(typeof value!=='boolean'){errors.push(path+' muss ein Wahr/Falsch-Wert sein.');}};
  function assertBackupSchema(obj){
    const errors=[];
    if(!isPlainObject(obj)){errors.push('Backup ist kein Objekt.');}
    const manifest=obj&&obj.manifest;
    if(!isPlainObject(manifest)){
      errors.push('manifest fehlt oder ist kein Objekt.');
    }else{
      const manifestChecks=[
        ensureString(manifest.generatedAt,'manifest.generatedAt',1),
        ensureString(manifest.version,'manifest.version',1),
        ensureString(manifest.theme,'manifest.theme',1)
      ].filter(Boolean);
      errors.push(...manifestChecks);
      if(!hasOwn(manifest,'modules')){errors.push('manifest.modules fehlt.');}
      const modules=ensureArray(manifest.modules,'manifest.modules',errors);
      modules.forEach((mod,idx)=>{
        if(!isPlainObject(mod)){errors.push(`manifest.modules[${idx}] muss ein Objekt sein.`);return;}
        const modErr=[
          ensureString(mod.id,`manifest.modules[${idx}].id`,1),
          ensureString(mod.name,`manifest.modules[${idx}].name`,1)
        ].filter(Boolean);
        errors.push(...modErr);
      });
      if(!hasOwn(manifest,'plugins')){errors.push('manifest.plugins fehlt.');}
      const plugins=ensureArray(manifest.plugins,'manifest.plugins',errors);
      plugins.forEach((plugin,idx)=>{
        if(!isPlainObject(plugin)){errors.push(`manifest.plugins[${idx}] muss ein Objekt sein.`);return;}
        const pluginErr=[
          ensureString(plugin.id,`manifest.plugins[${idx}].id`,1),
          ensureString(plugin.name,`manifest.plugins[${idx}].name`,1),
          ensureString(plugin.version??'',`manifest.plugins[${idx}].version`,0,true),
          ensureString(plugin.moduleId,`manifest.plugins[${idx}].moduleId`,1)
        ].filter(Boolean);
        errors.push(...pluginErr);
      });
      if(!isPlainObject(manifest.archives)){
        errors.push('manifest.archives fehlt oder ist kein Objekt.');
      }else{
        ['genres','moods','categories'].forEach(key=>{
          const value=manifest.archives[key];
          if(typeof value!=='number'||value<0){errors.push(`manifest.archives.${key} muss eine Zahl >= 0 sein.`);}
        });
      }
      if(!hasOwn(manifest,'playlist')){errors.push('manifest.playlist fehlt.');}
      if(typeof manifest.playlist!=='number'||manifest.playlist<0){errors.push('manifest.playlist muss eine Zahl >= 0 sein.');}
      if(!hasOwn(manifest,'settings')){errors.push('manifest.settings fehlt.');}
      if(!isPlainObject(manifest.settings)){
        errors.push('manifest.settings fehlt oder ist kein Objekt.');
      }else{
        ensureBoolean(manifest.settings.autosave,'manifest.settings.autosave',errors);
        ensureBoolean(manifest.settings.selfrepair,'manifest.settings.selfrepair',errors);
        ensureBoolean(manifest.settings.toasts,'manifest.settings.toasts',errors);
        if(hasOwn(manifest.settings,'respectSystemMotion')){ensureBoolean(manifest.settings.respectSystemMotion,'manifest.settings.respectSystemMotion',errors);}
        if(hasOwn(manifest.settings,'reduceMotion')){ensureBoolean(manifest.settings.reduceMotion,'manifest.settings.reduceMotion',errors);}
        if(hasOwn(manifest.settings,'respectSystemContrast')){ensureBoolean(manifest.settings.respectSystemContrast,'manifest.settings.respectSystemContrast',errors);}
        if(hasOwn(manifest.settings,'highContrast')){ensureBoolean(manifest.settings.highContrast,'manifest.settings.highContrast',errors);}
        if(hasOwn(manifest.settings,'fontScale')){
          const size=Number(manifest.settings.fontScale);
          if(!allowedFontScales.has(size)){errors.push('manifest.settings.fontScale muss 14, 16, 18 oder 20 sein.');}
        }
        if(hasOwn(manifest.settings,'configPreset')){
          const presetKey=safeLower(manifest.settings.configPreset);
          if(!CONFIG_PRESETS[presetKey]){errors.push('manifest.settings.configPreset ist unbekannt.');}
        }
      }
    }
    const statePart=obj&&obj.state;
    if(!isPlainObject(statePart)){
      errors.push('state fehlt oder ist kein Objekt.');
    }else{
      const stateChecks=[
        ensureString(statePart.theme,'state.theme',1),
        typeof statePart.autosave==='boolean'?null:'state.autosave muss ein Wahr/Falsch-Wert sein.',
        typeof statePart.selfrepair==='boolean'?null:'state.selfrepair muss ein Wahr/Falsch-Wert sein.',
        typeof statePart.toasts==='boolean'?null:'state.toasts muss ein Wahr/Falsch-Wert sein.',
        statePart.respectSystemMotion===undefined||typeof statePart.respectSystemMotion==='boolean'?null:'state.respectSystemMotion muss ein Wahr/Falsch-Wert sein.',
        statePart.reduceMotion===undefined||typeof statePart.reduceMotion==='boolean'?null:'state.reduceMotion muss ein Wahr/Falsch-Wert sein.',
        statePart.respectSystemContrast===undefined||typeof statePart.respectSystemContrast==='boolean'?null:'state.respectSystemContrast muss ein Wahr/Falsch-Wert sein.',
        statePart.highContrast===undefined||typeof statePart.highContrast==='boolean'?null:'state.highContrast muss ein Wahr/Falsch-Wert sein.',
        statePart.fontScale===undefined||allowedFontScales.has(Math.round(Number(statePart.fontScale)||0))?null:'state.fontScale muss 14, 16, 18 oder 20 sein.',
        statePart.configPreset===undefined||CONFIG_PRESETS[safeLower(statePart.configPreset)]?null:'state.configPreset ist unbekannt.'
      ].filter(Boolean);
      errors.push(...stateChecks);
      if(!hasOwn(statePart,'modules')){errors.push('state.modules fehlt.');}
      const modules=ensureArray(statePart.modules,'state.modules',errors);
      modules.forEach((mod,idx)=>{
        if(!isPlainObject(mod)){errors.push(`state.modules[${idx}] muss ein Objekt sein.`);return;}
        const modErr=[
          ensureString(mod.id,`state.modules[${idx}].id`,1),
          ensureString(mod.name,`state.modules[${idx}].name`,1)
        ].filter(Boolean);
        errors.push(...modErr);
      });
      if(statePart.categories!=null){
        if(!isPlainObject(statePart.categories)){errors.push('state.categories muss ein Objekt sein.');}
        else{
          Object.entries(statePart.categories).forEach(([key,value])=>{
            if(!isPlainObject(value)){errors.push(`state.categories.${key} muss ein Objekt sein.`);return;}
            const genres=ensureArray(value.genres||[] ,`state.categories.${key}.genres`,errors);
            genres.forEach((item,i)=>{const err=ensureString(item,`state.categories.${key}.genres[${i}]`,1);if(err)errors.push(err);});
            const moods=ensureArray(value.moods||[],`state.categories.${key}.moods`,errors);
            moods.forEach((item,i)=>{const err=ensureString(item,`state.categories.${key}.moods[${i}]`,1);if(err)errors.push(err);});
          });
        }
      }
      if(!hasOwn(statePart,'genres')){errors.push('state.genres fehlt.');}
      const genreArr=ensureArray(statePart.genres,'state.genres',errors);
      genreArr.forEach((g,i)=>{const err=ensureString(g,`state.genres[${i}]`,1);if(err)errors.push(err);});
      if(!hasOwn(statePart,'moods')){errors.push('state.moods fehlt.');}
      const moodArr=ensureArray(statePart.moods,'state.moods',errors);
      moodArr.forEach((m,i)=>{const err=ensureString(m,`state.moods[${i}]`,1);if(err)errors.push(err);});
      if(!hasOwn(statePart,'playlist')){errors.push('state.playlist fehlt.');}
      const playlist=ensureArray(statePart.playlist,'state.playlist',errors);
      playlist.forEach((track,idx)=>{
        if(!isPlainObject(track)){errors.push(`state.playlist[${idx}] muss ein Objekt sein.`);return;}
        const trackErr=[
          ensureString(track.id,`state.playlist[${idx}].id`,1),
          ensureString(track.title??'',`state.playlist[${idx}].title`,0,true),
          ensureString(track.artist??'',`state.playlist[${idx}].artist`,0,true),
          ensureString(track.src,`state.playlist[${idx}].src`,1)
        ].filter(Boolean);
        errors.push(...trackErr);
      });
      if(!hasOwn(statePart,'plugins')){errors.push('state.plugins fehlt.');}
      const plugins=ensureArray(statePart.plugins,'state.plugins',errors);
      plugins.forEach((plugin,idx)=>{
        if(!isPlainObject(plugin)){errors.push(`state.plugins[${idx}] muss ein Objekt sein.`);return;}
        const pluginErr=[
          ensureString(plugin.id,`state.plugins[${idx}].id`,1),
          ensureString(plugin.name,`state.plugins[${idx}].name`,1),
          ensureString(plugin.moduleId,`state.plugins[${idx}].moduleId`,1),
          ensureString(plugin.moduleName,`state.plugins[${idx}].moduleName`,1)
        ].filter(Boolean);
        errors.push(...pluginErr);
        if(plugin.sections!=null){
          const sections=ensureArray(plugin.sections,`state.plugins[${idx}].sections`,errors);
          sections.forEach((sec,sIdx)=>{
            if(!isPlainObject(sec)){errors.push(`state.plugins[${idx}].sections[${sIdx}] muss ein Objekt sein.`);return;}
            const secErr=[
              ensureString(sec.title??'',`state.plugins[${idx}].sections[${sIdx}].title`,0,true),
              ensureString(sec.content??'',`state.plugins[${idx}].sections[${sIdx}].content`,0,true)
            ].filter(Boolean);
            errors.push(...secErr);
          });
        }
        if(plugin.links!=null){
          const links=ensureArray(plugin.links,`state.plugins[${idx}].links`,errors);
          links.forEach((link,lIdx)=>{
            if(!isPlainObject(link)){errors.push(`state.plugins[${idx}].links[${lIdx}] muss ein Objekt sein.`);return;}
            const linkErr=[
              ensureString(link.label,`state.plugins[${idx}].links[${lIdx}].label`,1),
              ensureString(link.url,`state.plugins[${idx}].links[${lIdx}].url`,1)
            ].filter(Boolean);
            errors.push(...linkErr);
            if(typeof link.url==='string'&&!/^https?:/i.test(link.url.trim())){
              errors.push(`state.plugins[${idx}].links[${lIdx}].url muss mit http(s) beginnen.`);
            }
          });
        }
      });
      if(!(typeof statePart.activeModule==='string'||statePart.activeModule===null)){
        errors.push('state.activeModule muss ein String oder null sein.');
      }
      if(!hasOwn(statePart,'log')){errors.push('state.log fehlt.');}
      const logArr=ensureArray(statePart.log,'state.log',errors);
      const allowedLogTypes=new Set(['info','ok','warn','error']);
      logArr.forEach((entry,idx)=>{
        if(!isPlainObject(entry)){errors.push(`state.log[${idx}] muss ein Objekt sein.`);return;}
        const logErr=[
          ensureString(entry.time,`state.log[${idx}].time`,1),
          ensureString(entry.msg??'',`state.log[${idx}].msg`,0,true)
        ].filter(Boolean);
        errors.push(...logErr);
        if(!allowedLogTypes.has(entry.type)){errors.push(`state.log[${idx}].type muss info/ok/warn/error sein.`);}
      });
      if(statePart.logFilter&&!['all','info','ok','warn','error'].includes(statePart.logFilter)){
        errors.push('state.logFilter muss all/info/ok/warn/error sein.');
      }
    }
    if(errors.length){
      throw new Error('Backup Schema verletzt:\n- '+errors.join('\n- '));
    }
  }
  function ensureModuleRegistryMatchesState(preferredId){
    const validIds=new Set();
    state.modules.filter(Boolean).forEach(m=>{
      const id=safeStr(m&&m.id).trim();
      if(!id)return;
      validIds.add(id);
      if(!moduleRegistry.has(id)){
        const name=safeStr(m&&m.name).trim()||'Unbenanntes Modul';
        moduleRegistry.set(id,el=>{
          el.innerHTML=`<h2>${escapeHtml(name)}</h2><p>Dieses Modul wurde geladen und wartet noch auf eigene Inhalte. Ergänze Funktionen oder verknüpfe ein Plugin.</p>`;
        });
      }
    });
    Array.from(moduleRegistry.keys()).forEach(id=>{
      if(!validIds.has(id)){
        moduleRegistry.delete(id);
      }
    });
    let fallbackId=null;
    if(preferredId&&validIds.has(preferredId)){
      fallbackId=preferredId;
    }
    if(!fallbackId){
      const first=state.modules.find(m=>m&&safeStr(m.id).trim());
      fallbackId=first?safeStr(first.id).trim():null;
    }
    if(state.activeModule&&!validIds.has(state.activeModule)){
      state.activeModule=fallbackId;
    }
    if(!state.activeModule&&fallbackId){
      state.activeModule=fallbackId;
    }
  }
  function toast(msg){if(!$('#toastsChk').checked)return;const t=document.createElement('div');t.textContent=msg;t.setAttribute('role','status');Object.assign(t.style,{position:'fixed',right:'14px',bottom:'14px',background:'var(--panel)',color:'var(--text)',border:'1px solid var(--border)',padding:'10px 12px',borderRadius:'12px',boxShadow:'var(--shadow)',zIndex:99});document.body.appendChild(t);setTimeout(()=>t.remove(),2400)}
  function addLog(type,msg){
    const lvl=normalizeLogType(type);
    const levelMeta=LOG_LEVELS[lvl];
    const time=new Date().toLocaleTimeString('de-DE',{hour12:false});
    const message=safeStr(msg).trim()||levelMeta.label;
    state.log.push({id:uuid(),time,type:lvl,msg:message});
    if(state.log.length>300)state.log.shift();
    announce(message,lvl);
    renderLog();
  }
  function renderLog(){loglist.innerHTML='';
    const rawFilter=safeLower(state.logFilter||'all');
    const filter=!rawFilter||rawFilter==='all'?'all':(KNOWN_LOG_LEVELS.has(rawFilter)?rawFilter:DEFAULT_LOG_LEVEL);
    const entries=state.log.filter(entry=>filter==='all'||normalizeLogType(entry.type)===filter).slice(-10);
    if(entries.length===0){
      const empty=document.createElement('li');
      empty.className='log-empty';
      empty.textContent='Keine Einträge für den gewählten Filter.';
      loglist.appendChild(empty);
      return;
    }
    entries.forEach(entry=>{
      const level=normalizeLogType(entry.type);
      const meta=LOG_LEVELS[level];
      const li=document.createElement('li');
      li.className='log-entry';
      li.dataset.type=level;
      li.dataset.label=meta.label;
      const icon=document.createElement('span');
      icon.className='log-icon';
      icon.setAttribute('aria-hidden','true');
      icon.textContent=meta.icon;
      const time=document.createElement('span');
      time.className='log-time';
      time.textContent=`[${safeStr(entry.time)||'--:--:--'}]`;
      const message=document.createElement('span');
      message.className='log-message';
      const sr=document.createElement('span');
      sr.className='sr-only';
      sr.textContent=meta.label+': ';
      message.appendChild(sr);
      message.append(safeStr(entry.msg));
      li.append(icon,time,message);
      loglist.appendChild(li);
    });
  }
  const LS_KEY='modultool_state_v1';
  function save(){try{localStorage.setItem(LS_KEY,JSON.stringify(state));addLog('ok','Gespeichert.')}catch(err){addLog('error','Speichern fehlgeschlagen: '+err.message)}}
  function load(){try{const raw=localStorage.getItem(LS_KEY);if(!raw)return;Object.assign(state,JSON.parse(raw));addLog('ok','Zustand geladen.')}catch(err){addLog('error','Laden fehlgeschlagen: '+err.message)}}
  function selfRepair(){
    let fixes=0;
    if(!Array.isArray(state.modules)){state.modules=[];fixes++;}
    if(!state.categories||typeof state.categories!=='object'){state.categories={};fixes++;}
    if(!Array.isArray(state.genres)){state.genres=[];fixes++;}
    if(!Array.isArray(state.moods)){state.moods=[];fixes++;}
    if(!Array.isArray(state.playlist)){state.playlist=[];fixes++;}
    if(!Array.isArray(state.log)){state.log=[];fixes++;}
    if(!['all','info','ok','warn','error'].includes(state.logFilter)){state.logFilter='all';fixes++;}
    if(typeof state.respectSystemMotion!=='boolean'){state.respectSystemMotion=true;fixes++;}
    if(typeof state.reduceMotion!=='boolean'){state.reduceMotion=systemReduceDefault;fixes++;}
    if(typeof state.respectSystemContrast!=='boolean'){state.respectSystemContrast=true;fixes++;}
    if(typeof state.highContrast!=='boolean'){state.highContrast=systemContrastDefault;fixes++;}
    const numericFont=Math.round(Number(state.fontScale)||0);
    if(!allowedFontScales.has(numericFont)){state.fontScale=systemFontDefault();fixes++;}
    else{state.fontScale=numericFont;}
    const seen=new Set();
    const modules=[];
    state.modules.filter(Boolean).forEach((m,idx)=>{
      const name=safeStr(m&&m.name).trim();
      const fallback=`Modul ${idx+1}`;
      const finalName=name||fallback;
      let id=safeStr(m&&m.id).trim();
      if(id) id=slugify(id);
      if(!id) id=slugify(finalName);
      if(!id) id=slugify(fallback);
      if(!id) id=`modul-${uuid().slice(-6)}`;
      while(!id||seen.has(id)){
        id=slugify(`${finalName}-${uuid().slice(-6)}`)||`modul-${uuid().slice(-6)}`;
      }
      seen.add(id);
      modules.push({id,name:finalName});
    });
    state.modules=modules;
    state.genres=[...new Set(state.genres.map(s=>safeStr(s).trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
    state.moods=[...new Set(state.moods.map(s=>safeStr(s).trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
    for(const c in state.categories){
      const cat=state.categories[c]||{genres:[],moods:[]};
      cat.genres=[...new Set((cat.genres||[]).map(s=>safeStr(s).trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
      cat.moods=[...new Set((cat.moods||[]).map(s=>safeStr(s).trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
      state.categories[c]=cat;
    }
    if(!Array.isArray(state.plugins)){state.plugins=[];fixes++;}
    const pluginIds=new Set();
    state.plugins=state.plugins.filter(Boolean).map(p=>{
      let id=safeStr(p&&p.id).trim();
      if(!id||pluginIds.has(id)){id=uuid();fixes++;}
      pluginIds.add(id);
      const name=safeStr(p&&p.name).trim()||'Unbenanntes Plugin';
      const description=safeStr(p&&p.description).trim();
      const version=safeStr(p&&p.version).trim();
      const author=safeStr(p&&p.author).trim();
      let moduleId=safeStr(p&&p.moduleId).trim();
      if(moduleId) moduleId=slugify(moduleId);
      let moduleName=safeStr(p&&p.moduleName).trim()||`Plugin – ${name}`;
      const sections=Array.isArray(p&&p.sections)?p.sections.map(sec=>{
        const title=safeStr(sec&&sec.title).trim();
        const content=safeStr(sec&&sec.content).trim();
        if(!title&&!content)return null;
        return{title:title||'Abschnitt',content};
      }).filter(Boolean):[];
      const links=Array.isArray(p&&p.links)?p.links.map(link=>{
        const label=safeStr(link&&link.label).trim()||safeStr(link&&link.title).trim();
        const url=safeStr(link&&link.url).trim();
        if(!url)return null;
        return{label:label||url,url};
      }).filter(Boolean):[];
      if(!moduleId||!seen.has(moduleId)){
        moduleId=slugify(`${name}-${id.slice(-6)}`);
        moduleName=moduleName||`Plugin – ${name}`;
        while(seen.has(moduleId)){
          moduleId=slugify(`${name}-${uuid().slice(-6)}`);
        }
        state.modules.push({id:moduleId,name:moduleName});
        seen.add(moduleId);
        fixes++;
      }
      return{id,name,description,version,author,moduleId,moduleName,sections,links};
    });
    ensureModuleRegistryMatchesState(state.activeModule||null);
    const matchedPreset=findPresetMatch(state)||'custom';
    state.configPreset=matchedPreset;
    if(fixes>0){
      addLog('warn','Self-Repair: '+fixes+' Korrekturen angewendet.');
    }else{
      addLog('info','Self-Repair: keine Änderungen nötig.');
    }
    return fixes;
  }
  function renderStats(){
    $('#stat-modules').textContent=state.modules.length;
    $('#stat-cats').textContent=Object.keys(state.categories).length;
    $('#stat-genres').textContent=state.genres.length;
    $('#stat-moods').textContent=state.moods.length;
    $('#stat-tracks').textContent=state.playlist.length;
    $('#countGenres').textContent=state.genres.length;
    $('#countMoods').textContent=state.moods.length;
    $('#countCats').textContent=Object.keys(state.categories).length;
    updateHelpStats();
  }
  function renderTheme(){
    if(docEl){docEl.setAttribute('data-theme',state.theme);}
    const themeSelect=$('#themeSel');
    if(themeSelect) themeSelect.value=state.theme;
    applyDisplayPreferences();
    refreshPluginFrames();
  }
  function renderModules(){const list=$('#modulesList');list.innerHTML='';const sorted=[...state.modules].sort((a,b)=>safeStr(a.name).localeCompare(safeStr(b.name)));const frag=document.createDocumentFragment();sorted.forEach(m=>{const btn=document.createElement('button');btn.className='btn block';btn.setAttribute('role','option');btn.innerHTML=`<span>${safeStr(m.name)||'Unbenannt'}</span><span class=\"small\">anzeigen</span>`;btn.addEventListener('click',()=>openModule(m.id));frag.appendChild(btn)});list.appendChild(frag)}
  function renderArchives(){const gl=$('#genresList');gl.innerHTML='';const gfrag=document.createDocumentFragment();state.genres.forEach(g=>{const li=document.createElement('li');li.textContent=g;gfrag.appendChild(li)});gl.appendChild(gfrag);const ml=$('#moodsList');ml.innerHTML='';const mfrag=document.createDocumentFragment();state.moods.forEach(m=>{const li=document.createElement('li');li.textContent=m;mfrag.appendChild(li)});ml.appendChild(mfrag)}
  function renderCategories(){const sel=$('#catSel');const rsel=$('#randCatSel');sel.innerHTML='';rsel.innerHTML='';const frag1=document.createDocumentFragment();const frag2=document.createDocumentFragment();Object.keys(state.categories).sort((a,b)=>a.localeCompare(b)).forEach(c=>{const o1=document.createElement('option');o1.value=c;o1.textContent=c;frag1.appendChild(o1);const o2=document.createElement('option');o2.value=c;o2.textContent=c;frag2.appendChild(o2)});sel.appendChild(frag1);rsel.appendChild(frag2)}
  function renderPlaylist(){
    const list=$('#playlist');
    list.innerHTML='';
    let activeOptionId=null;
    if(state.playlist.length===0){
      const empty=document.createElement('p');
      empty.className='muted';
      empty.textContent='Noch keine Titel vorhanden. Nutze Import oder ziehe Dateien hierher.';
      list.appendChild(empty);
      list.removeAttribute('aria-activedescendant');
      return;
    }
    const frag=document.createDocumentFragment();
    state.playlist.forEach((t,idx)=>{
      const row=document.createElement('div');
      row.className='item';
      row.setAttribute('role','option');
      row.setAttribute('tabindex','0');
      row.setAttribute('draggable','true');
      row.dataset.index=idx;
      let trackId=safeStr(t.id).trim();
      if(!trackId){trackId=uuid();t.id=trackId;}
      row.dataset.trackId=trackId;
      const rowId=`playlist-item-${trackId}`;
      row.id=rowId;
      const isActive=state._currentIndex===idx;
      row.setAttribute('aria-selected',isActive?'true':'false');
      row.title='Enter: Abspielen • Entf: Entfernen • Alt+Pfeile: Sortieren';
      if(isActive) activeOptionId=rowId;
      const meta=document.createElement('div');
      meta.className='meta';
      const title=document.createElement('strong');
      title.textContent=safeStr(t.title)||'Unbenannt';
      const artist=document.createElement('span');
      artist.className='muted';
      artist.textContent=safeStr(t.artist)||'–';
      meta.appendChild(title);
      meta.appendChild(artist);
      const actions=document.createElement('div');
      actions.className='row item-actions';
      const playBtn=document.createElement('button');
      playBtn.className='btn inline';
      playBtn.dataset.act='play';
      playBtn.setAttribute('aria-label','Titel abspielen');
      playBtn.type='button';
      playBtn.textContent='▶';
      const upBtn=document.createElement('button');
      upBtn.className='btn inline';
      upBtn.dataset.act='up';
      upBtn.setAttribute('aria-label','Titel nach oben verschieben');
      upBtn.type='button';
      upBtn.textContent='↑';
      upBtn.disabled=idx===0;
      const downBtn=document.createElement('button');
      downBtn.className='btn inline';
      downBtn.dataset.act='down';
      downBtn.setAttribute('aria-label','Titel nach unten verschieben');
      downBtn.type='button';
      downBtn.textContent='↓';
      downBtn.disabled=idx===state.playlist.length-1;
      const delBtn=document.createElement('button');
      delBtn.className='btn inline warn';
      delBtn.dataset.act='del';
      delBtn.setAttribute('aria-label','Titel entfernen');
      delBtn.type='button';
      delBtn.textContent='✖';
      actions.appendChild(playBtn);
      actions.appendChild(upBtn);
      actions.appendChild(downBtn);
      actions.appendChild(delBtn);
      row.appendChild(meta);
      row.appendChild(actions);
      frag.appendChild(row);
    });
    list.appendChild(frag);
    if(activeOptionId) list.setAttribute('aria-activedescendant',activeOptionId);
    else list.removeAttribute('aria-activedescendant');
  }
  function focusPlaylistItem(trackId){
    if(!trackId)return;
    const escaped=typeof CSS!=='undefined'&&CSS.escape?CSS.escape(trackId):trackId.replace(/["']/g,'');
    requestAnimationFrame(()=>{
      const target=document.querySelector(`#playlist .item[data-track-id="${escaped}"]`);
      if(target) target.focus();
    });
  }
  function tick(){const now=new Date();$('#clock').textContent=now.toLocaleTimeString('de-DE',{hour12:false});$('#today').textContent=now.toLocaleDateString('de-DE',{weekday:'long',year:'numeric',month:'long',day:'2-digit'})}
  const moduleIdTaken=id=>!!id&&(state.modules.some(m=>m&&m.id===id)||moduleRegistry.has(id));
  function nextModuleId(name,preferred){
    const baseName=safeStr(name).trim()||'modul';
    let candidate=safeStr(preferred).trim();
    if(candidate) candidate=slugify(candidate);
    if(!candidate) candidate=slugify(baseName);
    if(!candidate) candidate=slugify(`modul-${Date.now()}`);
    if(!candidate) candidate=`modul-${uuid().slice(-6)}`;
    let suffix=2;
    while(moduleIdTaken(candidate)){
      candidate=slugify(`${baseName}-${suffix++}`)||`modul-${uuid().slice(-6)}`;
    }
    return candidate;
  }
  function renderPluginModuleContent(el,pluginId){
    const plugin=state.plugins.find(p=>p.id===pluginId);
    if(!plugin){
      el.innerHTML='<h2>Plugin nicht gefunden</h2><p>Bitte importiere das Plugin erneut.</p>';
      return;
    }
    const header=document.createElement('div');
    header.className='col';
    header.innerHTML=`<h2>${escapeHtml(plugin.name)}</h2><p class="muted">${escapeHtml(plugin.description||'Dieses Plugin enthält keine Beschreibung.')}</p>`;
    const meta=document.createElement('div');
    meta.className='row';
    meta.style.flexWrap='wrap';
    meta.style.gap='8px';
    [['Version',plugin.version||'n/a'],['Autor',plugin.author||'unbekannt']].forEach(([label,value])=>{
      const badge=document.createElement('span');
      badge.className='chip';
      badge.innerHTML=`<strong>${escapeHtml(label)}:</strong> ${escapeHtml(value)}`;
      meta.appendChild(badge);
    });
    header.appendChild(meta);
    el.appendChild(header);
    if(plugin.sections&&plugin.sections.length){
      const themeSnapshot=getThemeTokens();
      plugin.sections.forEach((sec,idx)=>{
        const box=document.createElement('section');
        box.className='panel pad';
        box.style.marginTop='12px';
        const rawTitle=safeStr(sec.title).trim();
        const heading=document.createElement('h3');
        heading.textContent=rawTitle||`Abschnitt ${idx+1}`;
        box.appendChild(heading);
        const sanitizedRaw=sanitizeHtml(safeStr(sec.content).replace(/\n/g,'<br>'));
        const finalContent=sanitizedRaw&&sanitizedRaw.trim()?sanitizedRaw:'<p class="muted">Keine Inhalte.</p>';
        const frame=document.createElement('iframe');
        frame.className='plugin-frame';
        frame.setAttribute('sandbox','allow-popups allow-popups-to-escape-sandbox');
        frame.setAttribute('referrerpolicy','no-referrer');
        frame.setAttribute('loading','lazy');
        const safePluginName=safeStr(plugin.name).trim()||'Plugin';
        const sectionLabel=rawTitle||'Inhalt';
        frame.title=`${safePluginName} – ${sectionLabel}`;
        frame.setAttribute('aria-label',`${safePluginName} – ${sectionLabel}`);
        frame.dataset.content=finalContent;
        frame.dataset.pluginName=safePluginName;
        frame.dataset.sectionTitle=sectionLabel;
        frame.setAttribute('srcdoc',buildPluginSandboxDocument(finalContent,themeSnapshot));
        box.appendChild(frame);
        el.appendChild(box);
      });
    }else{
      const empty=document.createElement('div');
      empty.className='panel pad';
      empty.innerHTML='<p>Keine strukturierten Inhalte hinterlegt.</p>';
      el.appendChild(empty);
    }
    if(plugin.links&&plugin.links.length){
      const linksWrap=document.createElement('div');
      linksWrap.className='panel pad';
      linksWrap.style.marginTop='12px';
      linksWrap.innerHTML='<h3>Links</h3>';
      const list=document.createElement('ul');
      list.style.padding='0';
      list.style.listStyle='none';
      plugin.links.forEach(link=>{
        const li=document.createElement('li');
        li.style.marginBottom='6px';
        const a=document.createElement('a');
        const url=safeStr(link.url);
        if(!/^https?:/i.test(url))return;
        a.href=url;
        a.target='_blank';
        a.rel='noopener noreferrer';
        a.textContent=`${safeStr(link.label)} →`;
        li.appendChild(a);
        list.appendChild(li);
      });
      linksWrap.appendChild(list);
      el.appendChild(linksWrap);
    }
  }
  function ensurePluginModule(plugin){
    if(!plugin)return;
    const moduleName=safeStr(plugin.moduleName).trim()||`Plugin – ${plugin.name}`;
    let moduleId=safeStr(plugin.moduleId).trim();
    moduleId=slugify(moduleId||`${plugin.name}-${plugin.id.slice(-6)}`);
    if(!moduleId) moduleId=slugify(`plugin-${plugin.id.slice(-6)}`)||`plugin-${uuid().slice(-6)}`;
    plugin.moduleName=moduleName;
    plugin.moduleId=moduleId;
    let existing=state.modules.find(m=>m.id===moduleId);
    const occupiedByOtherPlugin=state.plugins.some(p=>p&&p!==plugin&&p.moduleId===moduleId);
    if(existing&&occupiedByOtherPlugin){
      moduleId=nextModuleId(moduleName,`${moduleId}-${plugin.id.slice(-4)}`);
      plugin.moduleId=moduleId;
      existing=null;
    }
    if(existing&&safeLower(existing.name)!==safeLower(moduleName)){
      moduleId=nextModuleId(moduleName,moduleId);
      plugin.moduleId=moduleId;
      existing=null;
    }
    if(!existing){
      state.modules.push({id:moduleId,name:moduleName});
      renderModules();
      renderStats();
    }else if(existing.name!==moduleName){
      existing.name=moduleName;
    }
    const renderPluginView=el=>renderPluginModuleContent(el,plugin.id);
    renderPluginView.pluginId=plugin.id;
    moduleRegistry.set(moduleId,renderPluginView);
  }
  function ensureAllPlugins(){state.plugins.forEach(ensurePluginModule);}
  function validatePluginData(data){
    if(!data||typeof data!=='object')throw new Error('Plugin-Datei ungültig');
    const name=safeStr(data.name).trim();
    if(!name)throw new Error('Plugin-Name fehlt');
    const description=safeStr(data.description).trim();
    const version=safeStr(data.version).trim();
    const author=safeStr(data.author).trim();
    const moduleName=safeStr(data.moduleName).trim();
    const moduleId=safeStr(data.moduleId).trim();
    const sections=Array.isArray(data.sections)?data.sections.map(sec=>{
      const title=safeStr(sec&&sec.title).trim();
      const content=safeStr(sec&&sec.content).trim();
      if(!title&&!content)return null;
      return{title:title||'Inhalt',content};
    }).filter(Boolean):[];
    const baseContent=safeStr(data.content).trim();
    if(!sections.length&&baseContent){sections.push({title:'Inhalt',content:baseContent});}
    const links=Array.isArray(data.links)?data.links.map(link=>{
      const label=safeStr(link&&link.label).trim()||safeStr(link&&link.title).trim();
      const url=safeStr(link&&link.url).trim();
      if(!url||!/^https?:/i.test(url))return null;
      return{label:label||url,url};
    }).filter(Boolean):[];
    return{name,description,version,author,moduleName,moduleId,sections,links};
  }
  function pluginExists(candidate){return state.plugins.some(p=>safeLower(p.name)===safeLower(candidate.name)&&safeLower(p.version||'')===safeLower(candidate.version||''));}
  function registerPlugin(candidate){
    if(pluginExists(candidate))throw new Error('Plugin mit gleicher Version bereits vorhanden');
    const plugin=Object.assign({id:uuid()},candidate);
    plugin.moduleName=safeStr(plugin.moduleName).trim()||`Plugin – ${plugin.name}`;
    plugin.moduleId=safeStr(plugin.moduleId).trim();
    state.plugins.push(plugin);
    ensurePluginModule(plugin);
    renderModules();
    renderStats();
    persist();
    addLog('ok','Plugin importiert: '+plugin.name);
    return plugin;
  }
  function removeModule(id){
    const idx=state.modules.findIndex(m=>m.id===id);
    if(idx===-1)return;
    const wasActive=state.activeModule===id;
    state.modules.splice(idx,1);
    moduleRegistry.delete(id);
    if(wasActive){
      state.activeModule=startId;
      openModule(startId);
    }
    renderModules();
    renderStats();
    ensureModuleRegistryMatchesState(state.activeModule||null);
    persist();
  }
  function removePlugin(id){
    const idx=state.plugins.findIndex(p=>p.id===id);
    if(idx===-1)return;
    const plugin=state.plugins[idx];
    state.plugins.splice(idx,1);
    if(plugin&&plugin.moduleId)removeModule(plugin.moduleId);
    persist();
    addLog('warn','Plugin entfernt: '+(plugin?plugin.name:'unbekannt'));
    if(state.activeModule===pluginOverviewId)openModule(pluginOverviewId);
  }
  function clearPlugins(){
    const ids=state.plugins.map(p=>p.id);
    ids.forEach(id=>removePlugin(id));
    ensureModuleRegistryMatchesState(state.activeModule||null);
  }
  function renderPluginOverview(el){
    el.innerHTML=`<h2>Plugin-Manager</h2><p>Importiere Erweiterungen im JSON-Format. Struktur: {"name","version","description","author","sections":[{"title","content"}]}.</p>`;
    const controls=document.createElement('div');
    controls.className='row';
    controls.style.gap='8px';
    const importBtn=document.createElement('button');
    importBtn.className='btn inline';
    importBtn.id='pluginImportBtn';
    importBtn.textContent='Plugin importieren';
    const file=document.createElement('input');
    file.type='file';
    file.accept='application/json';
    file.id='pluginImportFile';
    file.style.display='none';
    controls.appendChild(importBtn);
    controls.appendChild(file);
    const hint=document.createElement('div');
    hint.className='muted';
    hint.textContent='Tipp: Plugins werden als eigene Module registriert und erscheinen in der Liste links.';
    controls.appendChild(hint);
    el.appendChild(controls);
    const list=document.createElement('div');
    list.className='col';
    list.style.marginTop='12px';
    if(state.plugins.length===0){
      const empty=document.createElement('div');
      empty.className='panel pad';
      empty.innerHTML='<p>Noch keine Plugins importiert.</p>';
      list.appendChild(empty);
    }else{
      state.plugins.forEach(plugin=>{
        const card=document.createElement('div');
        card.className='panel pad';
        card.style.display='flex';
        card.style.flexDirection='column';
        card.style.gap='6px';
        const head=document.createElement('div');
        head.className='row';
        head.style.justifyContent='space-between';
        head.style.gap='6px';
        head.style.flexWrap='wrap';
        const title=document.createElement('strong');
        title.textContent=safeStr(plugin.name);
        const meta=document.createElement('span');
        meta.className='muted';
        meta.textContent=`v${safeStr(plugin.version||'n/a')} • ${safeStr(plugin.author||'unbekannt')}`;
        head.appendChild(title);
        head.appendChild(meta);
        const desc=document.createElement('p');
        desc.textContent=safeStr(plugin.description||'Keine Beschreibung hinterlegt.');
        card.appendChild(head);
        card.appendChild(desc);
        const actions=document.createElement('div');
        actions.className='row';
        actions.style.gap='6px';
        const openBtn=document.createElement('button');
        openBtn.className='btn inline';
        openBtn.textContent='Anzeigen';
        openBtn.addEventListener('click',()=>openModule(plugin.moduleId));
        const exportBtn=document.createElement('button');
        exportBtn.className='btn inline';
        exportBtn.textContent='Exportieren';
        exportBtn.addEventListener('click',()=>exportPlugin(plugin));
        const removeBtn=document.createElement('button');
        removeBtn.className='btn inline warn';
        removeBtn.textContent='Entfernen';
        removeBtn.addEventListener('click',()=>{if(confirm('Plugin wirklich entfernen?'))removePlugin(plugin.id);});
        actions.appendChild(openBtn);
        actions.appendChild(exportBtn);
        actions.appendChild(removeBtn);
        card.appendChild(actions);
        list.appendChild(card);
      });
    }
    el.appendChild(list);
    importBtn.addEventListener('click',()=>file.click());
    file.addEventListener('change',e=>{
      const f=e.target.files[0];
      if(!f)return;
      const reader=new FileReader();
      reader.onload=()=>{
        try{
          const json=JSON.parse(reader.result||'{}');
          const pluginData=validatePluginData(json);
          const plugin=registerPlugin(pluginData);
          openModule(plugin.moduleId);
        }catch(err){
          addLog('error','Plugin-Import: '+err.message);
          toast('Plugin konnte nicht geladen werden.');
        }finally{
          file.value='';
        }
      };
      reader.readAsText(f);
    });
  }
  function renderBackupInspector(el){
    el.innerHTML=`<h2>Backup-Prüfung</h2><p>Hier prüfst du Sicherungen (Backups) gegen das Projektschema (Regelwerk für Daten). Du kannst JSON einfügen, eine Datei auswählen oder den aktuellen Zustand prüfen.</p>`;
    const intro=document.createElement('div');
    intro.className='muted';
    intro.innerHTML='<p><strong>Tipps:</strong> Fehler werden dir unten erklärt. Bei Erfolg siehst du eine Zusammenfassung der Inhalte.</p>';
    el.appendChild(intro);
    const textarea=document.createElement('textarea');
    textarea.id='backupCheckInput';
    textarea.rows=12;
    textarea.style.width='100%';
    textarea.placeholder='Backup-JSON hier einfügen…';
    el.appendChild(textarea);
    const actions=document.createElement('div');
    actions.className='row';
    actions.style.marginTop='10px';
    const fileBtn=document.createElement('button');
    fileBtn.className='btn inline';
    fileBtn.textContent='Datei prüfen';
    const textBtn=document.createElement('button');
    textBtn.className='btn inline';
    textBtn.textContent='Text prüfen';
    const currentBtn=document.createElement('button');
    currentBtn.className='btn inline';
    currentBtn.textContent='Aktuellen Zustand prüfen';
    actions.appendChild(fileBtn);
    actions.appendChild(textBtn);
    actions.appendChild(currentBtn);
    el.appendChild(actions);
    const hiddenFile=document.createElement('input');
    hiddenFile.type='file';
    hiddenFile.accept='application/json';
    hiddenFile.style.display='none';
    el.appendChild(hiddenFile);
    const resultBox=document.createElement('div');
    resultBox.className='panel pad';
    resultBox.style.marginTop='12px';
    resultBox.setAttribute('role','status');
    resultBox.setAttribute('aria-live','polite');
    resultBox.setAttribute('aria-atomic','true');
    resultBox.setAttribute('tabindex','-1');
    resultBox.textContent='Noch keine Prüfung durchgeführt.';
    el.appendChild(resultBox);
    const summary=document.createElement('div');
    summary.className='panel pad';
    summary.style.marginTop='10px';
    summary.innerHTML='<strong>Zusammenfassung</strong><p class="muted">Wird nach einer erfolgreichen Prüfung angezeigt.</p>';
    el.appendChild(summary);
    function showResult(type,message,details){
      resultBox.textContent=message;
      resultBox.style.borderColor=type==='ok'?'var(--ok)':type==='warn'?'var(--warn)':'var(--err)';
      resultBox.style.color=type==='ok'?'var(--ok)':type==='warn'?'var(--warn)':'var(--err)';
      if(type==='ok'){
        summary.innerHTML=details;
      }else{
        const text=escapeHtml(details||'Fehler ohne Beschreibung').replace(/\n/g,'<br>');
        summary.innerHTML='<strong>Zusammenfassung</strong><p class="muted">'+text+'</p>';
      }
      try{resultBox.focus({preventScroll:true});}catch(e){/* ignore focus errors */}
    }
    function formatSummary(validState,manifest){
      const fallbackStats={
        modules:validState.modules.length,
        plugins:validState.plugins.length,
        playlist:validState.playlist.length,
        archives:{
          genres:validState.genres.length,
          moods:validState.moods.length,
          categories:Object.keys(validState.categories).length
        }
      };
      const stats=manifest&&isPlainObject(manifest)?{
        modules:Array.isArray(manifest.modules)?manifest.modules.length:fallbackStats.modules,
        plugins:Array.isArray(manifest.plugins)?manifest.plugins.length:fallbackStats.plugins,
        playlist:typeof manifest.playlist==='number'?manifest.playlist:fallbackStats.playlist,
        archives:isPlainObject(manifest.archives)?{
          genres:manifest.archives.genres??fallbackStats.archives.genres,
          moods:manifest.archives.moods??fallbackStats.archives.moods,
          categories:manifest.archives.categories??fallbackStats.archives.categories
        }:fallbackStats.archives
      }:fallbackStats;
      return `
        <strong>Zusammenfassung</strong>
        <ul>
          <li>Module: <strong>${stats.modules}</strong></li>
          <li>Plugins: <strong>${stats.plugins}</strong></li>
          <li>Playlist-Titel: <strong>${stats.playlist}</strong></li>
          <li>Genres/Moods: <strong>${stats.archives.genres}</strong>/<strong>${stats.archives.moods}</strong></li>
          <li>Kategorien: <strong>${stats.archives.categories}</strong></li>
        </ul>
      `;
    }
    function runCheck(source,jsonText){
      const trimmed=safeStr(jsonText).trim();
      if(!trimmed){toast('Keine Daten gefunden.');announceProcess('Backup-Prüfung abgebrochen: keine Daten.','warn');return;}
      try{
        announceProcess(`Backup-Prüfung (${source}) läuft…`,'info');
        const parsed=JSON.parse(trimmed);
        assertBackupSchema(parsed);
        const sanitized=validateBackup(parsed);
        const manifest=parsed.manifest;
        showResult('ok',`Backup gültig (${source}).`,formatSummary(sanitized,manifest));
        addLog('ok','Backup geprüft: '+source);
        announceProcess(`Backup-Prüfung erfolgreich (${source}).`,'ok');
      }catch(err){
        const message=err&&err.message?err.message:'Unbekannter Fehler';
        showResult('error','Fehler bei der Prüfung: '+message,message);
        addLog('error','Backup-Prüfung fehlgeschlagen: '+message);
        announceProcess('Backup-Prüfung fehlgeschlagen: '+message,'error','assertive');
      }
    }
    fileBtn.addEventListener('click',()=>hiddenFile.click());
    hiddenFile.addEventListener('change',()=>{
      const file=hiddenFile.files&&hiddenFile.files[0];
      if(!file)return;
      const reader=new FileReader();
      announceProcess('Backup-Datei wird geladen…','info');
      reader.onload=()=>{textarea.value=reader.result||'';runCheck('Datei',textarea.value);hiddenFile.value='';};
      reader.readAsText(file);
    });
    textBtn.addEventListener('click',()=>runCheck('Texteingabe',textarea.value));
    currentBtn.addEventListener('click',()=>{
      const current=JSON.stringify(buildBackup(),null,2);
      textarea.value=current;
      runCheck('aktueller Zustand',current);
    });
  }
  function registerModule(name,renderFn){
    const safeName=safeStr(name).trim()||'Unbenanntes Modul';
    let id=slugify(safeName);
    const existing=state.modules.find(m=>m&&m.id===id);
    if(existing){
      existing.name=safeName;
    }else{
      id=nextModuleId(safeName,id);
      state.modules.push({id,name:safeName});
      addLog('ok','Modul registriert: '+safeName);
      renderModules();
      renderStats();
      persist();
    }
    moduleRegistry.set(id,typeof renderFn==='function'?renderFn:(el)=>{el.innerHTML=`<h2>${safeName}</h2><p>Kein Renderer definiert.</p>`});
    ensureModuleRegistryMatchesState(id);
    return id;
  }
  function openModule(id){const renderFn=moduleRegistry.get(id);if(!renderFn){addLog('error','Modul nicht vorhanden: '+id);return}state.activeModule=id;const el=$('#canvas');el.innerHTML='';renderFn(el);addLog('ok','Modul geöffnet: '+id)}
  const startId=registerModule('Start – Hinweise',(el)=>{el.innerHTML=`<h2>Start – Hinweise</h2><p>Dieses Modul erklärt die Bedienung. Links: Module, Rechts: Audio, Unten: Archiv & Zufall. Alles persistiert automatisch.</p><ul><li>Drag&Drop Audio in die rechte Dropzone.</li><li>Genres/Moods eingeben und per Enter übernehmen.</li><li>Kategorien anlegen und oben im Zufallsbereich auswählen.</li></ul>`});
  const pluginOverviewId=registerModule('Plugin-Manager',renderPluginOverview);
  registerModule('Notiz-Editor',(el)=>{const ta=document.createElement('textarea');ta.style.width='100%';ta.style.height='50vh';ta.placeholder='Deine Notizen…';ta.value=localStorage.getItem('modultool_notes')||'';ta.addEventListener('input',()=>localStorage.setItem('modultool_notes',ta.value));el.appendChild(ta)});
  const backupCheckId=registerModule('Backup-Prüfung',renderBackupInspector);
  helpTopics=createHelpTopics();
  renderHelpTopics();
  updateHelpStats();
  const splitInput=str=>safeStr(str).split(',').map(s=>s.trim()).filter(Boolean);
  function addToArchive(targetArr,items){const before=targetArr.length;items.forEach(x=>{if(!targetArr.includes(x))targetArr.push(x)});targetArr.sort((a,b)=>a.localeCompare(b));return targetArr.length-before}
  function addGenres(){const items=splitInput($('#genreInput').value);if(items.length===0)return toast('Keine Genres erkannt.');const added=addToArchive(state.genres,items);const cat=$('#catSel').value;if(cat&&state.categories[cat]){addToArchive(state.categories[cat].genres,items)}$('#genreInput').value='';renderArchives();renderStats();persist();addLog(added>0?'ok':'warn',added>0?'Genres hinzugefügt: +'+added:'Keine neuen Genres (Duplikate)')}
  function addMoods(){const items=splitInput($('#moodInput').value);if(items.length===0)return toast('Keine Moods erkannt.');const added=addToArchive(state.moods,items);const cat=$('#catSel').value;if(cat&&state.categories[cat]){addToArchive(state.categories[cat].moods,items)}$('#moodInput').value='';renderArchives();renderStats();persist();addLog(added>0?'ok':'warn',added>0?'Moods hinzugefügt: +'+added:'Keine neuen Moods (Duplikate)')}
  function addCategory(){const name=safeStr($('#catName').value).trim();if(!name)return toast('Kategoriename fehlt.');if(state.categories[name]){toast('Kategorie existiert.');return}state.categories[name]={genres:[],moods:[]};$('#catName').value='';renderCategories();renderStats();persist();addLog('ok','Kategorie angelegt: '+name)}
  function delCategory(){const c=$('#catSel').value;if(!c)return toast('Keine Kategorie gewählt.');if(!confirm('Kategorie „'+c+'“ wirklich löschen?'))return;delete state.categories[c];renderCategories();renderStats();persist();addLog('ok','Kategorie gelöscht: '+c)}
  function pickRandom(arr,n){const pool=[...new Set(arr)];const out=[];while(pool.length&&out.length<n){const i=Math.floor(Math.random()*pool.length);out.push(pool.splice(i,1)[0])}return out}
  function runRandom(custom=false){const c=$('#randCatSel').value;let gsrc=state.genres,msrc=state.moods;if(c&&state.categories[c]){const cc=state.categories[c];gsrc=cc.genres.length?cc.genres:gsrc;msrc=cc.moods.length?cc.moods:msrc}const gn=custom?Math.max(1,+$('#randG').value|0):+(this&&this.dataset?this.dataset.g:0)||3;const mn=custom?Math.max(1,+$('#randM').value|0):+(this&&this.dataset?this.dataset.m:0)||3;const g=pickRandom(gsrc,gn);const m=pickRandom(msrc,mn);const out=`${g.join(', ')}`+(m.length?`, ${m.join(', ')}`:'');$('#randOut').value=out;addLog('ok','Zufall bereitgestellt ('+g.length+'/'+m.length+').')}
  async function copyOutput(){try{const text=$('#randOut').value;if(navigator.clipboard&&window.isSecureContext){await navigator.clipboard.writeText(text)}else{$('#randOut').select();document.execCommand('copy')}toast('In Zwischenablage kopiert.')}catch(e){addLog('error','Kopieren fehlgeschlagen: '+e.message)}}
  const audio=$('#player');
  function fileToTrack(file){return new Promise(res=>{const url=URL.createObjectURL(file);const base=safeStr(file.name).replace(/\.[^.]+$/,'');let title=base,artist='';const parts=base.split(' - ');if(parts.length>=2){artist=parts[0];title=parts.slice(1).join(' - ')}res({id:uuid(),title,artist,src:url,_blob:true})})}
  function addFiles(files){const arr=Array.from(files||[]);if(!arr.length)return;const first=state.playlist.length===0;Promise.all(arr.map(fileToTrack)).then(tracks=>{state.playlist.push(...tracks);if(first){state._currentIndex=0;const t=state.playlist[0];$('#nowMeta').textContent=`${safeStr(t.artist)||''} ${t.artist?'– ':''}${safeStr(t.title)||'Unbenannt'}`}renderPlaylist();renderStats();persist();addLog('ok',tracks.length+' Track(s) hinzugefügt.')})}
  function playIndex(i){
    if(i<0||i>=state.playlist.length){toast('Keine Tracks.');return}
    const track=state.playlist[i];
    state._currentIndex=i;
    renderPlaylist();
    focusPlaylistItem(track.id);
    audio.src=track.src;
    try{audio.currentTime=0;}catch{}
    const meta=`${safeStr(track.artist)||''} ${track.artist?'– ':''}${safeStr(track.title)||'Unbenannt'}`;
    $('#nowMeta').textContent=meta;
    const playPromise=audio.play();
    if(playPromise&&playPromise.then){
      playPromise.then(()=>{
        $('#nowMeta').textContent=meta;
        addLog('ok','Spiele: '+safeStr(track.title));
      }).catch(()=>{
        $('#nowMeta').textContent=meta;
      });
    }else{
      addLog('ok','Spiele: '+safeStr(track.title));
    }
  }
  function next(){if(typeof state._currentIndex!=="number")return;if(state.playlist.length===0)return;playIndex((state._currentIndex+1)%state.playlist.length)}
  function prev(){if(typeof state._currentIndex!=="number")return;if(state.playlist.length===0)return;playIndex((state._currentIndex-1+state.playlist.length)%state.playlist.length)}
  function revokeIfBlob(track){try{if(track&&track._blob&&track.src){URL.revokeObjectURL(track.src);track.src=''}}catch{}}
  function removeTrackAt(idx){
    if(idx<0||idx>=state.playlist.length)return;
    const [t]=state.playlist.splice(idx,1);
    revokeIfBlob(t);
    if(typeof state._currentIndex==='number'){
      if(idx<state._currentIndex) state._currentIndex--;
      else if(idx===state._currentIndex) state._currentIndex=null;
    }
    const nextTrack=state.playlist[Math.min(idx,state.playlist.length-1)];
    renderPlaylist();
    renderStats();
    persist();
    addLog('ok','Track entfernt.');
    if(nextTrack) focusPlaylistItem(nextTrack.id);
  }
  function reorderPlaylist(from,to){
    if(from===to||from<0||to<0||from>=state.playlist.length||to>=state.playlist.length)return;
    const moved=state.playlist.splice(from,1)[0];
    state.playlist.splice(to,0,moved);
    if(typeof state._currentIndex==='number'){
      if(from===state._currentIndex) state._currentIndex=to;
      else if(from<state._currentIndex&&to>=state._currentIndex) state._currentIndex--;
      else if(from>state._currentIndex&&to<=state._currentIndex) state._currentIndex++;
    }
    renderPlaylist();
    persist();
    addLog('ok','Playlist umsortiert.');
    focusPlaylistItem(moved&&moved.id);
  }
  function exportPlaylist(){const data=JSON.stringify(state.playlist.map(({id,title,artist,src})=>({id,title,artist,src})),null,2);download('playlist.json',data);addLog('ok','Playlist manifestiert.')}
  function importPlaylist(){const inp=document.createElement('input');inp.type='file';inp.accept='application/json';inp.addEventListener('change',()=>{const f=inp.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{try{state.playlist.forEach(revokeIfBlob);const arr=JSON.parse(r.result||'[]');if(!Array.isArray(arr))throw new Error('Kein Array');state.playlist=arr.filter(x=>x&&x.src).map(x=>({id:x.id||uuid(),title:safeStr(x.title)||'Unbenannt',artist:safeStr(x.artist)||'',src:x.src}));renderPlaylist();renderStats();persist();addLog('ok','Playlist importiert.')}catch(e){addLog('error','Import-Fehler: '+e.message)}};r.readAsText(f)});inp.click()}
  function generateManifest(){
    return{
      generatedAt:new Date().toISOString(),
      version:state.version,
      theme:state.theme,
      modules:state.modules.map(m=>({id:m.id,name:m.name})),
      plugins:state.plugins.map(p=>({id:p.id,name:p.name,version:p.version||'n/a',moduleId:p.moduleId})),
      archives:{genres:state.genres.length,moods:state.moods.length,categories:Object.keys(state.categories).length},
      playlist:state.playlist.length,
      settings:{autosave:!!state.autosave,selfrepair:!!state.selfrepair,toasts:state.toasts!==false,respectSystemMotion:!!state.respectSystemMotion,reduceMotion:isReduceMotionActive(),respectSystemContrast:!!state.respectSystemContrast,highContrast:isHighContrastActive(),fontScale:allowedFontScales.has(Number(state.fontScale))?Number(state.fontScale):systemFontDefault(),configPreset:state.configPreset&&CONFIG_PRESETS[state.configPreset]?state.configPreset:(findPresetMatch(state)||'custom')}
    };
  }
  function buildBackup(){
    return{
      manifest:generateManifest(),
      state:{
        theme:state.theme,
        autosave:!!state.autosave,
        selfrepair:!!state.selfrepair,
        toasts:state.toasts!==false,
        respectSystemMotion:!!state.respectSystemMotion,
        reduceMotion:!!state.reduceMotion,
        respectSystemContrast:!!state.respectSystemContrast,
        highContrast:!!state.highContrast,
        fontScale:allowedFontScales.has(Number(state.fontScale))?Number(state.fontScale):systemFontDefault(),
        modules:state.modules,
        categories:state.categories,
        genres:state.genres,
        moods:state.moods,
        playlist:state.playlist.map(({id,title,artist,src})=>({id,title,artist,src})),
        plugins:state.plugins,
        activeModule:state.activeModule,
        log:state.log.slice(-50),
        logFilter:state.logFilter||'all',
        configPreset:state.configPreset&&CONFIG_PRESETS[state.configPreset]?state.configPreset:(findPresetMatch(state)||'custom')
      }
    };
  }
  function downloadManifest(){download('modultool-manifest.json',JSON.stringify(generateManifest(),null,2));addLog('ok','Manifest exportiert.');announceProcess('Manifest exportiert.','ok');}
  function exportAll(){download('modultool_backup.json',JSON.stringify(buildBackup(),null,2));addLog('ok','Backup exportiert (Manifest + Daten).');announceProcess('Backup exportiert (Manifest + Daten).','ok');}
  function validateBackup(obj){
    if(!obj||typeof obj!=='object')throw new Error('Backup hat kein Objekt');
    const statePart=obj.state;
    if(!statePart||typeof statePart!=='object')throw new Error('State fehlt');
    const sanitizeStringArray=arr=>Array.isArray(arr)?[...new Set(arr.map(x=>safeStr(x).trim()).filter(Boolean))]:[];
    const sanitizeModules=arr=>Array.isArray(arr)?arr.filter(Boolean).map((m,idx)=>{
      const name=safeStr(m&&m.name).trim();
      const fallback=`Import Modul ${idx+1}`;
      const finalName=name||fallback;
      let id=safeStr(m&&m.id).trim();
      if(id) id=slugify(id);
      if(!id) id=slugify(finalName);
      if(!id) id=`import-${uuid().slice(-6)}`;
      return{id,name:finalName};
    }):[];
    const sanitizeCategories=catObj=>{
      if(!catObj||typeof catObj!=='object')return{};
      const out={};
      Object.keys(catObj).forEach(key=>{
        const cleanKey=safeStr(key).trim();
        if(!cleanKey)return;
        const entry=catObj[key]&&typeof catObj[key]==='object'?catObj[key]:{};
        const genres=sanitizeStringArray(entry.genres).sort((a,b)=>a.localeCompare(b));
        const moods=sanitizeStringArray(entry.moods).sort((a,b)=>a.localeCompare(b));
        out[cleanKey]={genres,moods};
      });
      return out;
    };
    const sanitized={
      theme:safeStr(statePart.theme).trim()||'neo',
      autosave:!!statePart.autosave,
      selfrepair:!!statePart.selfrepair,
      toasts:statePart.toasts!==false,
      respectSystemMotion:statePart.respectSystemMotion===undefined?true:!!statePart.respectSystemMotion,
      reduceMotion:statePart.reduceMotion===undefined?systemReduceDefault:!!statePart.reduceMotion,
      respectSystemContrast:statePart.respectSystemContrast===undefined?true:!!statePart.respectSystemContrast,
      highContrast:statePart.highContrast===undefined?systemContrastDefault:!!statePart.highContrast,
      fontScale:allowedFontScales.has(Math.round(Number(statePart.fontScale)||0))?Math.round(Number(statePart.fontScale)||0):systemFontDefault(),
      modules:sanitizeModules(statePart.modules),
      categories:sanitizeCategories(statePart.categories),
      genres:sanitizeStringArray(statePart.genres).sort((a,b)=>a.localeCompare(b)),
      moods:sanitizeStringArray(statePart.moods).sort((a,b)=>a.localeCompare(b)),
      playlist:Array.isArray(statePart.playlist)?statePart.playlist.filter(x=>x&&x.src).map(x=>({id:x.id||uuid(),title:safeStr(x.title)||'Unbenannt',artist:safeStr(x.artist)||'',src:safeStr(x.src)})):[],
      plugins:Array.isArray(statePart.plugins)?statePart.plugins:[],
      activeModule:statePart.activeModule||null,
      log:Array.isArray(statePart.log)?statePart.log:[],
      logFilter:['all','info','ok','warn','error'].includes(statePart.logFilter)?statePart.logFilter:'all'
    };
    const rawPreset=safeLower(statePart.configPreset);
    const detectedPreset=CONFIG_PRESETS[rawPreset]?rawPreset:(findPresetMatch(sanitized)||'custom');
    sanitized.configPreset=detectedPreset;
    return sanitized;
  }
  function pluginToSerializable(plugin){
    if(!plugin)return{};
    const sections=Array.isArray(plugin.sections)?plugin.sections.map(sec=>({title:safeStr(sec&&sec.title).trim(),content:safeStr(sec&&sec.content).trim()})):[];
    const links=Array.isArray(plugin.links)?plugin.links.map(link=>({label:safeStr(link&&link.label).trim()||safeStr(link&&link.title).trim(),url:safeStr(link&&link.url).trim()})).filter(l=>l.url&&/^https?:/i.test(l.url)):[];
    return{
      name:safeStr(plugin.name).trim(),
      description:safeStr(plugin.description).trim(),
      version:safeStr(plugin.version).trim(),
      author:safeStr(plugin.author).trim(),
      moduleName:safeStr(plugin.moduleName).trim(),
      moduleId:safeStr(plugin.moduleId).trim(),
      sections:sections.filter(sec=>sec.title||sec.content),
      links
    };
  }
  function exportPlugin(plugin){
    const data=pluginToSerializable(plugin);
    if(!data.name){toast('Plugin hat keinen Namen.');return;}
    const fileName=`${slugify(data.name)||'plugin'}-${safeStr(plugin.id).slice(-6)||'export'}.json`;
    download(fileName,JSON.stringify(data,null,2));
    addLog('ok','Plugin exportiert: '+data.name);
  }
  function importAll(file){
    announceProcess('Import gestartet – Daten werden geprüft.','info');
    const r=new FileReader();
    r.onload=()=>{
      try{
        state.playlist.forEach(revokeIfBlob);
        const raw=JSON.parse(r.result||'{}');
        assertBackupSchema(raw);
        const valid=validateBackup(raw);
        state.theme=valid.theme;
        state.autosave=valid.autosave;
        state.selfrepair=valid.selfrepair;
        state.toasts=valid.toasts;
        state.respectSystemMotion=valid.respectSystemMotion;
        state.reduceMotion=valid.reduceMotion;
        state.respectSystemContrast=valid.respectSystemContrast;
        state.highContrast=valid.highContrast;
        state.fontScale=valid.fontScale;
        state.modules=valid.modules;
        state.categories=valid.categories;
        state.genres=valid.genres;
        state.moods=valid.moods;
        state.playlist=valid.playlist;
        state.plugins=valid.plugins;
        state.activeModule=valid.activeModule;
        state.log=valid.log;
        state.logFilter=valid.logFilter;
        state.configPreset=valid.configPreset;
        selfRepair();
        ensureAllPlugins();
        renderAll();
        persist();
        addLog('ok','Gesamtdaten importiert.');
        announceProcess('Import abgeschlossen.','ok');
      }catch(e){
        addLog('error','Import-Fehler: '+e.message);
        announceProcess('Import fehlgeschlagen: '+(e&&e.message?e.message:'Unbekannt'),'error','assertive');
      }
    };
    r.readAsText(file);
  }
  function download(name,content){const type=name.endsWith('.txt')?'text/plain':'application/json';const blob=new Blob([content],{type});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=name;a.click();setTimeout(()=>URL.revokeObjectURL(url),2000);}
  function persist(){if($('#autosaveChk').checked)save();}
  function runSelfTests(){let pass=0,fail=0;announceProcess('Selbsttests gestartet.','info');function test(n,fn){try{fn();pass++;addLog('ok','TEST ✓ '+n)}catch(e){fail++;addLog('error','TEST ✗ '+n+': '+e.message)}}
    test('slugify(undefined)',()=>{slugify(undefined)});
    test('safeLower(null)',()=>{safeLower(null)});
    test('renderModules null-safe',()=>{const b=[...state.modules];state.modules=[{id:'a'},{id:'b',name:'Bravo'},{id:'c',name:undefined}];selfRepair();renderModules();state.modules=b;renderModules()});
    test('registerModule(undefined)',()=>{const id=registerModule(undefined,null);if(!id)throw new Error('Kein ID')});
    test('safeLower number',()=>{safeLower(123)});
    test('runRandom no dataset',()=>{runRandom.call(null,false)});
    test('slugify diacritics',()=>{if(!slugify('ÄÖÜ ß Ã'))throw new Error('leer')});
    test('theme fallback',()=>{const p=state.theme;state.theme='x';renderTheme();state.theme=p;renderTheme()});
    addLog(fail===0?'ok':'error','Selbsttests abgeschlossen: '+pass+' ok, '+fail+' fail');
    announceProcess('Selbsttests abgeschlossen: '+pass+' ok, '+fail+' fail',fail===0?'ok':'error',fail===0?'polite':'assertive');}
  function bindEvents(){
    if(helpCloseBtn){helpCloseBtn.addEventListener('click',closeHelp);}
    if(helpOverlay){helpOverlay.addEventListener('click',e=>{if(e.target===helpOverlay)closeHelp();});}
    if(configCloseBtn){configCloseBtn.addEventListener('click',closeConfigAssistant);}
    if(configOverlay){configOverlay.addEventListener('click',e=>{if(e.target===configOverlay)closeConfigAssistant();});}
    if(configApplyBtn){configApplyBtn.addEventListener('click',closeConfigAssistant);}
    if(configResetBtn){configResetBtn.addEventListener('click',()=>activateConfigPreset('balanced'));}
    const configBtn=$('#configBtn');
    if(configBtn){configBtn.addEventListener('click',()=>openConfigAssistant());}
    if(configPresetList){configPresetList.addEventListener('click',e=>{const btn=e.target.closest('button[data-preset]');if(!btn)return;activateConfigPreset(btn.dataset.preset);});}
    configThemeButtons.forEach(btn=>btn.addEventListener('click',()=>{const value=btn.dataset.theme;if(!value)return;const themeSel=$('#themeSel');if(themeSel){themeSel.value=value;themeSel.dispatchEvent(new Event('change',{bubbles:true}));}}));
    configFontButtons.forEach(btn=>btn.addEventListener('click',()=>{const value=btn.dataset.font;if(!value)return;if(fontScaleSel){fontScaleSel.value=value;fontScaleSel.dispatchEvent(new Event('change',{bubbles:true}));}}));
    const relayCheckbox=(control,selector)=>{if(!control)return;control.addEventListener('change',()=>{const target=$(selector);if(!target)return;if(target.checked!==control.checked){target.checked=control.checked;}target.dispatchEvent(new Event('change',{bubbles:true}));});};
    relayCheckbox(configAutosave,'#autosaveChk');
    relayCheckbox(configSelfrepair,'#selfrepairChk');
    relayCheckbox(configToasts,'#toastsChk');
    relayCheckbox(configSystemMotion,'#systemMotionChk');
    relayCheckbox(configReduceMotion,'#reduceMotionChk');
    relayCheckbox(configSystemContrast,'#systemContrastChk');
    relayCheckbox(configHighContrast,'#highContrastChk');
    if(helpCopyBtn){helpCopyBtn.addEventListener('click',copyHelpNotes);}
    if(helpDownloadBtn){helpDownloadBtn.addEventListener('click',downloadHelpNotes);}
    $('#themeSel').addEventListener('change',e=>{state.theme=e.target.value;renderTheme();persist();addLog('ok','Theme: '+state.theme);handleSettingChanged();});
    $('#toggleLeft').addEventListener('click',()=>{document.body.classList.toggle('collapsed-left')});
    $('#toggleRight').addEventListener('click',()=>{document.body.classList.toggle('collapsed-right')});
    $('#autosaveChk').addEventListener('change',()=>{state.autosave=$('#autosaveChk').checked;persist();handleSettingChanged();});
    $('#selfrepairChk').addEventListener('change',()=>{state.selfrepair=$('#selfrepairChk').checked;persist();handleSettingChanged();});
    $('#toastsChk').addEventListener('change',()=>{state.toasts=$('#toastsChk').checked;persist();handleSettingChanged();});
    if(systemMotionChk){systemMotionChk.addEventListener('change',()=>{state.respectSystemMotion=systemMotionChk.checked;if(state.respectSystemMotion){addLog('info','System-Animationen aktiv.');}else{addLog('info','Eigene Animationseinstellung aktiv.');}applyMotionPreference();renderDisplaySettings();persist();handleSettingChanged();});}
    if(reduceMotionChk){reduceMotionChk.addEventListener('change',()=>{state.reduceMotion=!!reduceMotionChk.checked;addLog('ok',state.reduceMotion?'Animationen reduziert.':'Animationen normal.');applyMotionPreference();renderDisplaySettings();persist();handleSettingChanged();});}
    if(systemContrastChk){systemContrastChk.addEventListener('change',()=>{state.respectSystemContrast=systemContrastChk.checked;if(state.respectSystemContrast){addLog('info','System-Kontrast aktiv.');}else{addLog('info','Eigene Kontrasteinstellung aktiv.');}applyContrastPreference();renderDisplaySettings();persist();handleSettingChanged();});}
    if(highContrastChk){highContrastChk.addEventListener('change',()=>{state.highContrast=!!highContrastChk.checked;addLog('ok',state.highContrast?'Hoher Kontrast aktiv.':'Normaler Kontrast aktiv.');applyContrastPreference();renderDisplaySettings();persist();handleSettingChanged();});}
    if(fontScaleSel){fontScaleSel.addEventListener('change',()=>{const parsed=Math.round(Number(fontScaleSel.value)||systemFontDefault());state.fontScale=allowedFontScales.has(parsed)?parsed:systemFontDefault();addLog('ok','Schriftgröße auf '+state.fontScale+' px gesetzt.');applyFontScale();renderDisplaySettings();persist();handleSettingChanged();});}
    $('#exportAllBtn').addEventListener('click',exportAll);
    $('#manifestBtn').addEventListener('click',downloadManifest);
    $('#importAllFile').addEventListener('change',e=>{const f=e.target.files[0];if(f)importAll(f)});
    $('#clearLogBtn').addEventListener('click',()=>{state.log=[];renderLog();persist()});
    $('#downloadLogBtn').addEventListener('click',()=>download('log.txt',state.log.map(l=>`[${l.time}] ${l.type}: ${l.msg}`).join('\n')));
    $('#aboutBtn').addEventListener('click',()=>openHelp('quickstart'));
    $('#selfTestBtn').addEventListener('click',runSelfTests);
    $('#logFilterSel').addEventListener('change',e=>{state.logFilter=e.target.value;renderLog();persist()});
    document.addEventListener('keydown',e=>{
      const key=safeLower(e&&e.key);
      if(e.ctrlKey&&key==='k'){
        e.preventDefault();
        $('#quickSearch').focus();
        return;
      }
      if(e.ctrlKey&&key==='s'){
        e.preventDefault();
        save();
        toast('Gespeichert.');
        return;
      }
      if(key==='f1'){
        e.preventDefault();
        openHelp('quickstart');
        return;
      }
      if(key==='escape'){
        if(isConfigOpen()){
          e.preventDefault();
          closeConfigAssistant();
          return;
        }
        if(isHelpOpen()){
          e.preventDefault();
          closeHelp();
          return;
        }
        let handled=false;
        if(document.body.classList.contains('collapsed-left')){document.body.classList.remove('collapsed-left');handled=true;}
        if(document.body.classList.contains('collapsed-right')){document.body.classList.remove('collapsed-right');handled=true;}
        if(handled){
          announceProcess('Ansicht zurückgesetzt.','info');
          const canvas=$('#canvas');
          if(canvas){try{canvas.focus({preventScroll:true});}catch(ex){/* ignore */}}
          e.preventDefault();
        }
      }
    });
    $('#quickSearch').addEventListener('input',()=>{const q=safeLower($('#quickSearch').value);$$('#modulesList .btn').forEach(btn=>{btn.style.display=safeLower(btn.textContent).includes(q)?'flex':'none'})});
    $('#addModuleBtn').addEventListener('click',onAddModule);
    $('#newModuleName').addEventListener('keydown',e=>{if(e.key==='Enter')onAddModule()});
    $('#addGenresBtn').addEventListener('click',addGenres);
    $('#genreInput').addEventListener('keydown',e=>{if(e.key==='Enter')addGenres()});
    $('#addMoodsBtn').addEventListener('click',addMoods);
    $('#moodInput').addEventListener('keydown',e=>{if(e.key==='Enter')addMoods()});
    $('#addCatBtn').addEventListener('click',addCategory);
    $('#delCatBtn').addEventListener('click',delCategory);
    $$('.btn[data-g]').forEach(b=>b.addEventListener('click',runRandom));
    $('#randGo').addEventListener('click',()=>runRandom(true));
    $('#copyOut').addEventListener('click',copyOutput);
    $('#impPlBtn').addEventListener('click',importPlaylist);
    $('#expPlBtn').addEventListener('click',exportPlaylist);
    $('#playBtn').addEventListener('click',()=>{if(typeof state._currentIndex!=="number"){if(state.playlist.length>0){playIndex(0)}else{toast('Keine Tracks.')}}else{if(audio.paused){const p=audio.play();if(p&&p.catch)p.catch(()=>playIndex(state._currentIndex))}else{audio.pause()}}});
    $('#nextBtn').addEventListener('click',next);
    $('#prevBtn').addEventListener('click',prev);
    const dz=$('#dropzone');
    dz.addEventListener('click',()=>$('#pickAudio').click());
    dz.addEventListener('keydown',e=>{const key=safeLower(e.key||'');if(key==='enter'||key===' '||key==='spacebar'){e.preventDefault();$('#pickAudio').click();}});
    dz.addEventListener('dragover',e=>{e.preventDefault();dz.style.opacity=.8});
    dz.addEventListener('dragleave',()=>dz.style.opacity=1);
    dz.addEventListener('drop',e=>{e.preventDefault();dz.style.opacity=1;addFiles(e.dataTransfer.files)});
    $('#pickAudio').addEventListener('change',e=>addFiles(e.target.files));
    const pl=$('#playlist');
    pl.addEventListener('click',e=>{const btn=e.target.closest('button[data-act]');if(!btn||btn.disabled)return;const item=e.target.closest('.item');if(!item)return;const idx=Number(item.dataset.index);if(Number.isNaN(idx))return;const act=btn.dataset.act;if(act==='play') playIndex(idx); else if(act==='del') removeTrackAt(idx); else if(act==='up') reorderPlaylist(idx,idx-1); else if(act==='down') reorderPlaylist(idx,idx+1);});
    pl.addEventListener('dblclick',e=>{const item=e.target.closest('.item');if(!item)return;const idx=Number(item.dataset.index);if(Number.isNaN(idx))return;playIndex(idx);});
    pl.addEventListener('dragstart',e=>{const item=e.target.closest('.item');if(!item)return;e.dataTransfer.setData('text/plain',item.dataset.index)});
    pl.addEventListener('dragover',e=>{e.preventDefault()});
    pl.addEventListener('drop',e=>{e.preventDefault();const to=e.target.closest('.item');if(!to)return;const from=Number(e.dataTransfer.getData('text/plain'));const toIdx=Number(to.dataset.index);if(Number.isNaN(from)||Number.isNaN(toIdx))return;reorderPlaylist(from,toIdx);});
    pl.addEventListener('keydown',e=>{const item=e.target.closest('.item');if(!item)return;const idx=Number(item.dataset.index);if(Number.isNaN(idx))return;const key=e.key;if((key==='Enter'||key===' '||key==='Spacebar')&&!e.altKey&&!e.ctrlKey&&!e.metaKey){e.preventDefault();playIndex(idx);}else if((key==='Delete'||key==='Backspace')&&!e.altKey&&!e.ctrlKey&&!e.metaKey){e.preventDefault();removeTrackAt(idx);}else if((key==='ArrowUp'||key==='ArrowDown')&&e.altKey){e.preventDefault();const target=key==='ArrowUp'?idx-1:idx+1;reorderPlaylist(idx,target);}});
  }
  function onAddModule(){const typed=safeStr($('#newModuleName').value).trim();const name=typed||`Modul ${state.modules.length+1}`;const id=registerModule(name,(el)=>{el.innerHTML=`<h2>${name}</h2><p>Neues Modul. Baue hier deine Funktionen ein.</p>`});$('#newModuleName').value='';renderModules();persist();openModule(id)}
  function renderAll(){
    ensureAllPlugins();
    ensureModuleRegistryMatchesState(startId);
    renderTheme();
    renderDisplaySettings();
    renderModules();
    renderArchives();
    renderCategories();
    renderPlaylist();
    renderStats();
    renderLog();
    const filterSel=$('#logFilterSel');
    if(filterSel)filterSel.value=state.logFilter||'all';
    updateConfigPresetState({skipLog:true});
    updateConfigSummary();
  }
  function init(){load();if(state.selfrepair)selfRepair();if(state.respectSystemMotion){state.reduceMotion=!!state.reduceMotion;}if(state.respectSystemContrast){state.highContrast=!!state.highContrast;}$('#autosaveChk').checked=!!state.autosave;$('#selfrepairChk').checked=!!state.selfrepair;$('#toastsChk').checked=state.toasts!==false;renderAll();bindEvents();bindMediaListeners();openModule(state.activeModule||startId);if(clockTimer)clearInterval(clockTimer);if(!isTestEnv){clockTimer=setInterval(tick,1000);}tick();announceProcess('Bereit für Aktionen.','info');addLog('ok','Bereit.')}
  const testApi={state,actions:{ensureModuleRegistryMatchesState,reorderPlaylist,removeTrackAt,renderPlaylist,renderAll,renderStats,renderModules,renderCategories,renderArchives,renderLog,generateManifest,buildBackup,validateBackup,runRandom,playIndex,validatePluginData,registerPlugin,removePlugin,pluginExists,ensurePluginModule,ensureAllPlugins,clearPlugins,assertBackupSchema,activateConfigPreset,moduleRendererExists(id){return moduleRegistry.has(id);},openModule,openHelp,closeHelp,isHelpOpen,buildHelpPlainText,getHelpTopics:()=>helpTopics.map(topic=>topic.id)},init,teardown(){if(clockTimer){clearInterval(clockTimer);clockTimer=null;}}};
  if(typeof window!=='undefined'){window.ModulToolTestAPI=testApi;}
  if(!isTestEnv){init();}
})();
</script>
</body>
</html>
