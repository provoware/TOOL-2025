{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "ModulTool Backup",
  "type": "object",
  "additionalProperties": false,
  "required": ["manifest", "state"],
  "properties": {
    "manifest": {
      "type": "object",
      "additionalProperties": false,
      "required": ["generatedAt", "version", "theme", "modules", "plugins", "archives", "playlist", "settings"],
      "properties": {
        "generatedAt": { "type": "string", "format": "date-time" },
        "version": { "type": "string", "minLength": 1 },
        "theme": { "type": "string", "minLength": 1 },
        "modules": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["id", "name"],
            "properties": {
              "id": { "type": "string", "minLength": 1 },
              "name": { "type": "string", "minLength": 1 }
            }
          }
        },
        "plugins": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["id", "name", "version", "moduleId"],
            "properties": {
              "id": { "type": "string", "minLength": 1 },
              "name": { "type": "string", "minLength": 1 },
              "version": { "type": "string" },
              "moduleId": { "type": "string", "minLength": 1 }
            }
          }
        },
        "archives": {
          "type": "object",
          "additionalProperties": false,
          "required": ["genres", "moods", "categories"],
          "properties": {
            "genres": { "type": "integer", "minimum": 0 },
            "moods": { "type": "integer", "minimum": 0 },
            "categories": { "type": "integer", "minimum": 0 }
          }
        },
        "playlist": { "type": "integer", "minimum": 0 },
        "digest": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "modules",
            "plugins",
            "categories",
            "genres",
            "moods",
            "playlist",
            "log"
          ],
          "properties": {
            "modules": { "type": "integer", "minimum": 0 },
            "plugins": { "type": "integer", "minimum": 0 },
            "categories": { "type": "integer", "minimum": 0 },
            "genres": { "type": "integer", "minimum": 0 },
            "moods": { "type": "integer", "minimum": 0 },
            "playlist": { "type": "integer", "minimum": 0 },
            "log": { "type": "integer", "minimum": 0 }
          }
        },
        "digestHistory": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["timestamp", "reason", "summary"],
            "properties": {
              "timestamp": { "type": "string", "format": "date-time" },
              "reason": {
                "type": "string",
                "enum": [
                  "state-change",
                  "state-loaded",
                  "state-imported",
                  "manual-save",
                  "layout-changed",
                  "module-registered",
                  "module-removed",
                  "plugin-registered",
                  "plugin-removed",
                  "playlist-added",
                  "playlist-removed",
                  "playlist-reordered",
                  "playlist-imported",
                  "log-cleared",
                  "log-filter-changed",
                  "settings-changed",
                  "genres-added",
                  "moods-added",
                  "category-added",
                  "category-removed"
                ]
              },
              "summary": { "type": "string", "minLength": 1 }
            }
          }
        },
        "settings": {
          "type": "object",
          "additionalProperties": false,
          "required": ["autosave", "selfrepair", "toasts", "smartErrors", "preventMistakes", "debugMode", "feedbackMode"],
          "properties": {
            "autosave": { "type": "boolean" },
            "selfrepair": { "type": "boolean" },
            "toasts": { "type": "boolean" },
            "respectSystemMotion": { "type": "boolean" },
            "reduceMotion": { "type": "boolean" },
            "respectSystemContrast": { "type": "boolean" },
            "highContrast": { "type": "boolean" },
            "fontScale": { "type": "integer", "enum": [14, 16, 18, 20] },
            "smartErrors": { "type": "boolean" },
            "preventMistakes": { "type": "boolean" },
            "debugMode": { "type": "boolean" },
            "feedbackMode": { "type": "string", "enum": ["full", "smart"] },
            "configPreset": {
              "type": "string",
              "enum": ["balanced", "accessibility", "focus", "performance", "custom"]
            },
            "layoutPreset": {
              "type": "string",
              "enum": [
                "balanced",
                "modules-wide",
                "audio-wide",
                "module-only",
                "audio-only",
                "workspace",
                "stacked"
              ]
            }
          },
          "settings": {
            "type": "object",
            "additionalProperties": false,
            "required": ["autosave", "selfrepair", "toasts"],
            "properties": {
              "autosave": { "type": "boolean" },
              "selfrepair": { "type": "boolean" },
              "toasts": { "type": "boolean" }
            }
          }
      }
    },
    "state": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "theme",
        "autosave",
        "selfrepair",
        "toasts",
        "modules",
        "categories",
        "genres",
        "moods",
        "playlist",
        "plugins",
        "activeModule",
        "log",
        "logFilter",
        "smartErrors",
        "preventMistakes",
        "debugMode",
        "feedbackMode"
      ],
      "properties": {
        "theme": { "type": "string", "minLength": 1 },
        "autosave": { "type": "boolean" },
        "selfrepair": { "type": "boolean" },
        "toasts": { "type": "boolean" },
       "respectSystemMotion": { "type": "boolean" },
        "reduceMotion": { "type": "boolean" },
        "respectSystemContrast": { "type": "boolean" },
        "highContrast": { "type": "boolean" },
        "fontScale": { "type": "integer", "enum": [14, 16, 18, 20] },
        "smartErrors": { "type": "boolean" },
        "preventMistakes": { "type": "boolean" },
        "debugMode": { "type": "boolean" },
        "feedbackMode": { "type": "string", "enum": ["full", "smart"] },
        "configPreset": {
          "type": "string",
          "enum": ["balanced", "accessibility", "focus", "performance", "custom"]
        },
        "layoutPreset": {
          "type": "string",
          "enum": [
            "balanced",
            "modules-wide",
            "audio-wide",
            "module-only",
            "audio-only",
            "workspace",
            "stacked"
          ]
        },
        "modules": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["id", "name"],
            "properties": {
              "id": { "type": "string", "minLength": 1 },
              "name": { "type": "string", "minLength": 1 }
            }
          }
        },
        "categories": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "additionalProperties": false,
            "required": ["genres", "moods"],
            "properties": {
              "genres": {
                "type": "array",
                "items": { "type": "string", "minLength": 1 },
                "uniqueItems": true
              },
              "moods": {
                "type": "array",
                "items": { "type": "string", "minLength": 1 },
                "uniqueItems": true
              }
            }
          }
        },
        "genres": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "uniqueItems": true
        },
        "moods": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "uniqueItems": true
        },
        "playlist": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["id", "title", "artist", "src"],
            "properties": {
              "id": { "type": "string", "minLength": 1 },
              "title": { "type": "string" },
              "artist": { "type": "string" },
              "src": { "type": "string", "minLength": 1 }
            }
          }
        },
        "plugins": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["id", "name", "moduleId", "moduleName"],
            "properties": {
              "id": { "type": "string", "minLength": 1 },
              "name": { "type": "string", "minLength": 1 },
              "description": { "type": "string" },
              "version": { "type": "string" },
              "author": { "type": "string" },
              "moduleId": { "type": "string", "minLength": 1 },
              "moduleName": { "type": "string", "minLength": 1 },
              "sections": {
                "type": "array",
                "items": {
                  "type": "object",
                  "additionalProperties": false,
                  "required": ["title", "content"],
                  "properties": {
                    "title": { "type": "string" },
                    "content": { "type": "string" }
                  }
                }
              },
              "links": {
                "type": "array",
                "items": {
                  "type": "object",
                  "additionalProperties": false,
                  "required": ["label", "url"],
                  "properties": {
                    "label": { "type": "string", "minLength": 1 },
                    "url": { "type": "string", "format": "uri" }
                  }
                }
              }
            }
          }
        },
        "activeModule": {
          "anyOf": [
            { "type": "string", "minLength": 1 },
            { "type": "null" }
          ]
        },
        "log": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["time", "type", "msg"],
            "properties": {
              "time": { "type": "string", "minLength": 1 },
              "type": { "type": "string", "enum": ["info", "ok", "warn", "error"] },
              "msg": { "type": "string" }
            }
          }
        },
        "logFilter": {
          "type": "string",
          "enum": ["all", "info", "ok", "warn", "error"]
        },
        "exportSequences": {
          "type": "object",
          "default": {},
          "additionalProperties": {
            "type": "object",
            "additionalProperties": false,
            "required": ["stamp", "counter"],
            "properties": {
              "stamp": { "type": "string", "pattern": "^\\d{8}-\\d{6}$" },
              "counter": { "type": "integer", "minimum": 1, "maximum": 999 }
            }
          }
        },
        "digestHistory": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["timestamp", "reason", "digest"],
            "properties": {
              "timestamp": { "type": "number" },
              "reason": {
                "type": "string",
                "enum": [
                  "state-change",
                  "state-loaded",
                  "state-imported",
                  "manual-save",
                  "layout-changed",
                  "module-registered",
                  "module-removed",
                  "plugin-registered",
                  "plugin-removed",
                  "playlist-added",
                  "playlist-removed",
                  "playlist-reordered",
                  "playlist-imported",
                  "log-cleared",
                  "log-filter-changed",
                  "settings-changed",
                  "genres-added",
                  "moods-added",
                  "category-added",
                  "category-removed"
                ]
              },
              "digest": {
                "type": "object",
                "additionalProperties": false,
                "required": [
                  "modules",
                  "plugins",
                  "categories",
                  "genres",
                  "moods",
                  "playlist",
                  "log"
                ],
                "properties": {
                  "modules": { "type": "integer", "minimum": 0 },
                  "plugins": { "type": "integer", "minimum": 0 },
                  "categories": { "type": "integer", "minimum": 0 },
                  "genres": { "type": "integer", "minimum": 0 },
                  "moods": { "type": "integer", "minimum": 0 },
                  "playlist": { "type": "integer", "minimum": 0 },
                  "log": { "type": "integer", "minimum": 0 }
                }
              }
            }
          }
        }
      }
    }
  }
}
